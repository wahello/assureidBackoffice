{"version":3,"sources":["meteor://ðŸ’»app/packages/ostrio:files/client.js","meteor://ðŸ’»app/packages/ostrio:files/core.js","meteor://ðŸ’»app/packages/ostrio:files/cursor.js","meteor://ðŸ’»app/packages/ostrio:files/lib.js","meteor://ðŸ’»app/packages/ostrio:files/upload.js"],"names":["module","export","FilesCollection","_","watch","require","v","Mongo","Meteor","Cookies","formatFleURL","check","Match","UploadInstance","FilesCollectionCore","NOOP","config","ddp","debug","schema","public","chunkSize","collection","downloadRoute","disableUpload","namingFunction","collectionName","onBeforeUpload","allowClientCode","onbeforeunloadMessage","self","cookie","isBoolean","Math","floor","isString","Collection","_name","filesCollection","String","Error","replace","isFunction","setTokenCookie","has","connection","_lastSessionId","get","set","path","unsetTokenCookie","remove","Accounts","startup","onLogin","onLogout","OneOf","Function","_URL","window","URL","webkitURL","mozURL","msURL","oURL","Worker","Blob","_supportWebWorker","_webWorkerUrl","createObjectURL","type","absoluteUrl","e","_debug","Boolean","Object","Number","Any","_methodNames","_Abort","_Write","_Start","_Remove","_getMimeType","fileData","mime","isObject","_getUser","result","user","userId","insert","autoStart","console","warn","selector","callback","JSON","stringify","Optional","call","Template","registerHelper","fileRef","version","EventEmitter","FilesCursor","FileCursor","info","log","apply","undefined","arguments","_getFileName","fileName","name","length","_getExt","indexOf","extension","split","pop","toLowerCase","ext","extensionWithDot","_updateFileTypes","data","isVideo","test","isAudio","isImage","isText","isJSON","isPDF","_dataToSchema","ds","meta","size","versions","original","_downloadRoute","_collectionName","fileId","_id","_storagePath","storagePath","extend","findOne","options","doc","find","update","link","optional","blackbox","updatedAt","Date","_fileRef","_collection","property","fetch","with","_selector","_current","cursor","hasNext","count","next","hasPrevious","previous","first","last","forEach","context","each","map","file","current","observe","callbacks","observeChanges","fixJSONParse","fixJSONStringify","obj","key","parseInt","isArray","i","isDate","_root","__meteor_runtime_config__","ROOT_URL","vRef","FileUpload","HTTP","Random","Tracker","ReactiveVar","isSafari","navigator","userAgent","streams","transport","allowWebWorkers","onError","onAbort","onStart","isBase64","onUploaded","onProgress","_file","time","worker","wwError","startTime","currentChunk","transferTime","trackerComp","sentChunks","fileLength","EOFsent","id","FSName","pipes","beforeunload","message","returnValue","addEventListener","_onEnd","emit","addListener","end","start","upload","sendEOF","prepare","sendChunk","proceedChunk","createStreams","throttle","_t","estimateTime","estimateSpeed","progress","round","estimateTimer","clearInterval","terminate","stop","removeEventListener","error","timeEnd","abort","state","evt","opts","binData","bin","chunkId","pad","p","content","headers","pause","eof","_result","parse","chunk","slice","fileReader","FileReader","onloadend","srcElement","target","onerror","readAsDataURL","FileReaderSync","onPause","postMessage","f","sc","cc","cs","ib","_len","ceil","clone","handleStart","continueFunc","pipe","func","push","isUploadAllowed","autorun","computation","curValue","status","connected","onmessage","manual","setInterval","_currentTime","continue","toggle"],"mappings":"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","file":"/packages/ostrio_files.js","sourcesContent":["import { _ }               from 'meteor/underscore';\nimport { Mongo }           from 'meteor/mongo';\nimport { Meteor }          from 'meteor/meteor';\nimport { Cookies }         from 'meteor/ostrio:cookies';\nimport { formatFleURL }    from './lib.js';\nimport { check, Match }    from 'meteor/check';\nimport { UploadInstance }  from './upload.js';\nimport FilesCollectionCore from './core.js';\n\nconst NOOP = () => { };\n\n/*\n * @locus Anywhere\n * @class FilesCollection\n * @param config           {Object}   - [Both]   Configuration object with next properties:\n * @param config.debug     {Boolean}  - [Both]   Turn on/of debugging and extra logging\n * @param config.ddp       {Object}   - [Client] Custom DDP connection. Object returned form `DDP.connect()`\n * @param config.schema    {Object}   - [Both]   Collection Schema\n * @param config.public    {Boolean}  - [Both]   Store files in folder accessible for proxy servers, for limits, and more - read docs`\n * @param config.chunkSize      {Number}  - [Both] Upload chunk size, default: 524288 bytes (0,5 Mb)\n * @param config.downloadRoute  {String}  - [Both]   Server Route used to retrieve files\n * @param config.collection     {Mongo.Collection} - [Both] Mongo Collection Instance\n * @param config.collectionName {String}  - [Both]   Collection name\n * @param config.namingFunction {Function}- [Both]   Function which returns `String`\n * @param config.onBeforeUpload {Function}- [Both]   Function which executes on server after receiving each chunk and on client right before beginning upload. Function context is `File` - so you are able to check for extension, mime-type, size and etc.\n * return `true` to continue\n * return `false` or `String` to abort upload\n * @param config.allowClientCode  {Boolean}  - [Both]   Allow to run `remove` from client\n * @param config.onbeforeunloadMessage {String|Function} - [Client] Message shown to user when closing browser's window or tab while upload process is running\n * @param config.disableUpload {Boolean} - Disable file upload, useful for server only solutions\n * @summary Create new instance of FilesCollection\n */\nexport class FilesCollection extends FilesCollectionCore {\n  constructor(config) {\n    super();\n    if (config) {\n      ({\n        ddp: this.ddp,\n        debug: this.debug,\n        schema: this.schema,\n        public: this.public,\n        chunkSize: this.chunkSize,\n        collection: this.collection,\n        downloadRoute: this.downloadRoute,\n        disableUpload: this.disableUpload,\n        namingFunction: this.namingFunction,\n        collectionName: this.collectionName,\n        onBeforeUpload: this.onBeforeUpload,\n        allowClientCode: this.allowClientCode,\n        onbeforeunloadMessage: this.onbeforeunloadMessage,\n      } = config);\n    }\n\n    const self = this;\n    const cookie = new Cookies();\n    if (!_.isBoolean(this.debug)) {\n      this.debug = false;\n    }\n\n    if (!_.isBoolean(this.public)) {\n      this.public = false;\n    }\n\n    if (!this.chunkSize) {\n      this.chunkSize = 1024 * 512;\n    }\n    this.chunkSize = Math.floor(this.chunkSize / 8) * 8;\n\n    if (!_.isString(this.collectionName) && !this.collection) {\n      this.collectionName = 'MeteorUploadFiles';\n    }\n\n    if (!this.collection) {\n      this.collection = new Mongo.Collection(this.collectionName);\n    } else {\n      this.collectionName = this.collection._name;\n    }\n\n    this.collection.filesCollection = this;\n    check(this.collectionName, String);\n\n    if (this.public && !this.downloadRoute) {\n      throw new Meteor.Error(500, `[FilesCollection.${this.collectionName}]: \\\"downloadRoute\\\" must be precisely provided on \\\"public\\\" collections! Note: \\\"downloadRoute\\\" must be equal or be inside of your web/proxy-server (relative) root.`);\n    }\n\n    if (!_.isBoolean(this.disableUpload)) {\n      this.disableUpload = false;\n    }\n\n    if (!_.isString(this.downloadRoute)) {\n      this.downloadRoute = '/cdn/storage';\n    }\n\n    this.downloadRoute = this.downloadRoute.replace(/\\/$/, '');\n\n    if (!_.isFunction(this.namingFunction)) {\n      this.namingFunction = false;\n    }\n\n    if (!_.isFunction(this.onBeforeUpload)) {\n      this.onBeforeUpload = false;\n    }\n\n    if (!_.isBoolean(this.allowClientCode)) {\n      this.allowClientCode = true;\n    }\n\n    if (!this.ddp) {\n      this.ddp = Meteor;\n    }\n\n    if (!this.onbeforeunloadMessage) {\n      this.onbeforeunloadMessage = 'Upload in a progress... Do you want to abort?';\n    }\n\n    const setTokenCookie = () => {\n      if ((!cookie.has('x_mtok') && Meteor.connection._lastSessionId) || (cookie.has('x_mtok') && (cookie.get('x_mtok') !== Meteor.connection._lastSessionId))) {\n        cookie.set('x_mtok', Meteor.connection._lastSessionId, {\n          path: '/'\n        });\n      }\n    };\n\n    const unsetTokenCookie = () => {\n      if (cookie.has('x_mtok')) {\n        cookie.remove('x_mtok', '/');\n      }\n    };\n\n    if (typeof Accounts !== 'undefined' && Accounts !== null) {\n      Meteor.startup(() => {\n        setTokenCookie();\n      });\n      Accounts.onLogin(() => {\n        setTokenCookie();\n      });\n      Accounts.onLogout(() => {\n        unsetTokenCookie();\n      });\n    }\n\n    check(this.onbeforeunloadMessage, Match.OneOf(String, Function));\n\n    try {\n      const _URL = window.URL || window.webkitURL || window.mozURL || window.msURL || window.oURL || false;\n      if (window.Worker && window.Blob && _URL) {\n        this._supportWebWorker = true;\n        this._webWorkerUrl     = _URL.createObjectURL(new Blob(['!function(a){\"use strict\";a.onmessage=function(b){var c=b.data.f.slice(b.data.cs*(b.data.cc-1),b.data.cs*b.data.cc);if(b.data.ib===!0)postMessage({bin:c,chunkId:b.data.cc});else{var d;a.FileReader?(d=new FileReader,d.onloadend=function(a){postMessage({bin:(d.result||a.srcElement||a.target).split(\",\")[1],chunkId:b.data.cc,s:b.data.s})},d.onerror=function(a){throw(a.target||a.srcElement).error},d.readAsDataURL(c)):a.FileReaderSync?(d=new FileReaderSync,postMessage({bin:d.readAsDataURL(c).split(\",\")[1],chunkId:b.data.cc})):postMessage({bin:null,chunkId:b.data.cc,error:\"File API is not supported in WebWorker!\"})}}}(this);'], {type: 'application/javascript'}));\n      } else if (window.Worker) {\n        this._supportWebWorker = true;\n        this._webWorkerUrl     = Meteor.absoluteUrl('packages/ostrio_files/worker.min.js');\n      } else {\n        this._supportWebWorker = false;\n      }\n    } catch (e) {\n      self._debug('[FilesCollection] [Check WebWorker Availability] Error:', e);\n      this._supportWebWorker = false;\n    }\n\n    if (!this.schema) {\n      this.schema = FilesCollectionCore.schema;\n    }\n\n    check(this.debug, Boolean);\n    check(this.schema, Object);\n    check(this.public, Boolean);\n    check(this.chunkSize, Number);\n    check(this.downloadRoute, String);\n    check(this.disableUpload, Boolean);\n    check(this.namingFunction, Match.OneOf(false, Function));\n    check(this.onBeforeUpload, Match.OneOf(false, Function));\n    check(this.allowClientCode, Boolean);\n    check(this.ddp, Match.Any);\n\n    this._methodNames = {\n      _Abort: `_FilesCollectionAbort_${this.collectionName}`,\n      _Write: `_FilesCollectionWrite_${this.collectionName}`,\n      _Start: `_FilesCollectionStart_${this.collectionName}`,\n      _Remove: `_FilesCollectionRemove_${this.collectionName}`\n    };\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollection\n   * @name _getMimeType\n   * @param {Object} fileData - File Object\n   * @summary Returns file's mime-type\n   * @returns {String}\n   */\n  _getMimeType(fileData) {\n    let mime;\n    check(fileData, Object);\n    if (_.isObject(fileData)) {\n      mime = fileData.type;\n    }\n\n    if (!mime || !_.isString(mime)) {\n      mime = 'application/octet-stream';\n    }\n    return mime;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollection\n   * @name _getUser\n   * @summary Returns object with `userId` and `user()` method which return user's object\n   * @returns {Object}\n   */\n  _getUser() {\n    const result = {\n      user() {\n        return null;\n      },\n      userId: null\n    };\n\n    if (_.isFunction(Meteor.userId)) {\n      result.user = () => Meteor.user();\n      result.userId = Meteor.userId();\n    }\n\n    return result;\n  }\n\n  /*\n   * @locus Client\n   * @memberOf FilesCollection\n   * @name insert\n   * @see https://developer.mozilla.org/en-US/docs/Web/API/FileReader\n   * @param {Object} config - Configuration object with next properties:\n   *   {File|Object} file           - HTML5 `files` item, like in change event: `e.currentTarget.files[0]`\n   *   {Object}      meta           - Additional data as object, use later for search\n   *   {Boolean}     allowWebWorkers- Allow/Deny WebWorkers usage\n   *   {Number|dynamic} streams     - Quantity of parallel upload streams, default: 2\n   *   {Number|dynamic} chunkSize   - Chunk size for upload\n   *   {String}      transport      - Upload transport `http` or `ddp`\n   *   {Object}      ddp            - Custom DDP connection. Object returned form `DDP.connect()`\n   *   {Function}    onUploaded     - Callback triggered when upload is finished, with two arguments `error` and `fileRef`\n   *   {Function}    onStart        - Callback triggered when upload is started after all successful validations, with two arguments `error` (always null) and `fileRef`\n   *   {Function}    onError        - Callback triggered on error in upload and/or FileReader, with two arguments `error` and `fileData`\n   *   {Function}    onProgress     - Callback triggered when chunk is sent, with only argument `progress`\n   *   {Function}    onBeforeUpload - Callback triggered right before upload is started:\n   *       return true to continue\n   *       return false to abort upload\n   * @param {Boolean} autoStart     - Start upload immediately. If set to false, you need manually call .start() method on returned class. Useful to set EventListeners.\n   * @summary Upload file to server over DDP or HTTP\n   * @returns {UploadInstance} Instance. UploadInstance has next properties:\n   *   {ReactiveVar} onPause  - Is upload process on the pause?\n   *   {ReactiveVar} state    - active|paused|aborted|completed\n   *   {ReactiveVar} progress - Current progress in percentage\n   *   {Function}    pause    - Pause upload process\n   *   {Function}    continue - Continue paused upload process\n   *   {Function}    toggle   - Toggle continue/pause if upload process\n   *   {Function}    abort    - Abort upload\n   *   {Function}    readAsDataURL - Current file as data URL, use to create image preview and etc. Be aware of big files, may lead to browser crash\n   */\n  insert(config, autoStart = true) {\n    if (this.disableUpload) {\n      console.warn('[FilesCollection] [insert()] Upload is disabled with [disableUpload]!');\n      return {};\n    }\n    return (new UploadInstance(config, this))[autoStart ? 'start' : 'manual']();\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollection\n   * @name remove\n   * @param {String|Object} selector - Mongo-Style selector (http://docs.meteor.com/api/collections.html#selectors)\n   * @param {Function} callback - Callback with one `error` argument\n   * @summary Remove documents from the collection\n   * @returns {FilesCollection} Instance\n   */\n  remove(selector = {}, callback) {\n    this._debug(`[FilesCollection] [remove(${JSON.stringify(selector)})]`);\n    check(selector, Match.OneOf(Object, String));\n    check(callback, Match.Optional(Function));\n\n    if (this.allowClientCode) {\n      this.ddp.call(this._methodNames._Remove, selector, (callback || NOOP));\n    } else {\n      callback && callback(new Meteor.Error(401, '[FilesCollection] [remove] Run code from client is not allowed!'));\n      this._debug('[FilesCollection] [remove] Run code from client is not allowed!');\n    }\n\n    return this;\n  }\n}\n\n/*\n * @locus Client\n * @TemplateHelper\n * @name fileURL\n * @param {Object} fileRef - File reference object\n * @param {String} version - [Optional] Version of file you would like to request\n * @summary Get download URL for file by fileRef, even without subscription\n * @example {{fileURL fileRef}}\n * @returns {String}\n */\nMeteor.startup(() => {\n  if (typeof Template !== 'undefined' && Template !== null) {\n    Template.registerHelper('fileURL', (fileRef, version = 'original') => {\n      if (!_.isObject(fileRef)) {\n        return '';\n      }\n\n      version = (!_.isString(version)) ? 'original' : version;\n      return formatFleURL(fileRef, version);\n    });\n  }\n});\n","import { _ }                       from 'meteor/underscore';\nimport { EventEmitter }            from 'eventemitter3';\nimport { formatFleURL }            from './lib.js';\nimport { check, Match }            from 'meteor/check';\nimport { FilesCursor, FileCursor } from './cursor.js';\n\nexport default class FilesCollectionCore extends EventEmitter {\n  constructor() {\n    super();\n  }\n\n  static schema = {\n    size: {\n      type: Number\n    },\n    name: {\n      type: String\n    },\n    type: {\n      type: String\n    },\n    path: {\n      type: String\n    },\n    isVideo: {\n      type: Boolean\n    },\n    isAudio: {\n      type: Boolean\n    },\n    isImage: {\n      type: Boolean\n    },\n    isText: {\n      type: Boolean\n    },\n    isJSON: {\n      type: Boolean\n    },\n    isPDF: {\n      type: Boolean\n    },\n    extension: {\n      type: String,\n      optional: true\n    },\n    _storagePath: {\n      type: String\n    },\n    _downloadRoute: {\n      type: String\n    },\n    _collectionName: {\n      type: String\n    },\n    public: {\n      type: Boolean,\n      optional: true\n    },\n    meta: {\n      type: Object,\n      blackbox: true,\n      optional: true\n    },\n    userId: {\n      type: String,\n      optional: true\n    },\n    updatedAt: {\n      type: Date,\n      optional: true\n    },\n    versions: {\n      type: Object,\n      blackbox: true\n    }\n  };\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name _debug\n   * @summary Print logs in debug mode\n   * @returns {void}\n   */\n  _debug() {\n    if (this.debug) {\n      (console.info || console.log || function () { }).apply(undefined, arguments);\n    }\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name _getFileName\n   * @param {Object} fileData - File Object\n   * @summary Returns file's name\n   * @returns {String}\n   */\n  _getFileName(fileData) {\n    const fileName = fileData.name || fileData.fileName;\n    if (_.isString(fileName) && (fileName.length > 0)) {\n      return (fileData.name || fileData.fileName).replace(/\\.\\./g, '').replace(/\\//g, '');\n    }\n    return '';\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name _getExt\n   * @param {String} FileName - File name\n   * @summary Get extension from FileName\n   * @returns {Object}\n   */\n  _getExt(fileName) {\n    if (!!~fileName.indexOf('.')) {\n      const extension = (fileName.split('.').pop().split('?')[0] || '').toLowerCase();\n      return { ext: extension, extension, extensionWithDot: `.${extension}` };\n    }\n    return { ext: '', extension: '', extensionWithDot: '' };\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name _updateFileTypes\n   * @param {Object} data - File data\n   * @summary Internal method. Classify file based on 'type' field\n   */\n  _updateFileTypes(data) {\n    data.isVideo  = /^video\\//i.test(data.type);\n    data.isAudio  = /^audio\\//i.test(data.type);\n    data.isImage  = /^image\\//i.test(data.type);\n    data.isText   = /^text\\//i.test(data.type);\n    data.isJSON   = /^application\\/json$/i.test(data.type);\n    data.isPDF    = /^application\\/(x-)?pdf$/i.test(data.type);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name _dataToSchema\n   * @param {Object} data - File data\n   * @summary Internal method. Build object in accordance with default schema from File data\n   * @returns {Object}\n   */\n  _dataToSchema(data) {\n    const ds = {\n      name: data.name,\n      extension: data.extension,\n      path: data.path,\n      meta: data.meta,\n      type: data.type,\n      size: data.size,\n      userId: data.userId || null,\n      versions: {\n        original: {\n          path: data.path,\n          size: data.size,\n          type: data.type,\n          extension: data.extension\n        }\n      },\n      _downloadRoute: data._downloadRoute || this.downloadRoute,\n      _collectionName: data._collectionName || this.collectionName\n    };\n\n    //Optional fileId\n    if (data.fileId) {\n      ds._id = data.fileId;\n    }\n\n    this._updateFileTypes(ds);\n    ds._storagePath = data._storagePath || this.storagePath(_.extend(data, ds));\n    return ds;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name findOne\n   * @param {String|Object} selector - Mongo-Style selector (http://docs.meteor.com/api/collections.html#selectors)\n   * @param {Object} options - Mongo-Style selector Options (http://docs.meteor.com/api/collections.html#sortspecifiers)\n   * @summary Find and return Cursor for matching document Object\n   * @returns {FileCursor} Instance\n   */\n  findOne(selector = {}, options) {\n    this._debug(`[FilesCollection] [findOne(${JSON.stringify(selector)}, ${JSON.stringify(options)})]`);\n    check(selector, Match.Optional(Match.OneOf(Object, String, Boolean, Number, null)));\n    check(options, Match.Optional(Object));\n\n    const doc = this.collection.findOne(selector, options);\n    if (doc) {\n      return new FileCursor(doc, this);\n    }\n    return doc;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name find\n   * @param {String|Object} selector - Mongo-Style selector (http://docs.meteor.com/api/collections.html#selectors)\n   * @param {Object}        options  - Mongo-Style selector Options (http://docs.meteor.com/api/collections.html#sortspecifiers)\n   * @summary Find and return Cursor for matching documents\n   * @returns {FilesCursor} Instance\n   */\n  find(selector = {}, options) {\n    this._debug(`[FilesCollection] [find(${JSON.stringify(selector)}, ${JSON.stringify(options)})]`);\n    check(selector, Match.Optional(Match.OneOf(Object, String, Boolean, Number, null)));\n    check(options, Match.Optional(Object));\n\n    return new FilesCursor(selector, options, this);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name update\n   * @see http://docs.meteor.com/#/full/update\n   * @summary link Mongo.Collection update method\n   * @returns {Mongo.Collection} Instance\n   */\n  update() {\n    this.collection.update.apply(this.collection, arguments);\n    return this.collection;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name link\n   * @param {Object} fileRef - File reference object\n   * @param {String} version - Version of file you would like to request\n   * @summary Returns downloadable URL\n   * @returns {String} Empty string returned in case if file not found in DB\n   */\n  link(fileRef, version = 'original') {\n    this._debug(`[FilesCollection] [link(${(_.isObject(fileRef) ? fileRef._id : undefined)}, ${version})]`);\n    check(fileRef, Object);\n    check(version, String);\n\n    if (!fileRef) {\n      return '';\n    }\n    return formatFleURL(fileRef, version);\n  }\n}\n","import { _ }      from 'meteor/underscore';\nimport { Meteor } from 'meteor/meteor';\n\n/*\n * @private\n * @locus Anywhere\n * @class FileCursor\n * @param _fileRef    {Object} - Mongo-Style selector (http://docs.meteor.com/api/collections.html#selectors)\n * @param _collection {FilesCollection} - FilesCollection Instance\n * @summary Internal class, represents each record in `FilesCursor.each()` or document returned from `.findOne()` method\n */\nexport class FileCursor {\n  constructor(_fileRef, _collection) {\n    this._fileRef    = _fileRef;\n    this._collection = _collection;\n    _.extend(this, _fileRef);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FileCursor\n   * @name remove\n   * @param callback {Function} - Triggered asynchronously after item is removed or failed to be removed\n   * @summary Remove document\n   * @returns {FileCursor}\n   */\n  remove(callback) {\n    this._collection._debug('[FilesCollection] [FileCursor] [remove()]');\n    if (this._fileRef) {\n      this._collection.remove(this._fileRef._id, callback);\n    } else {\n      callback && callback(new Meteor.Error(404, 'No such file'));\n    }\n    return this;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FileCursor\n   * @name link\n   * @param version {String} - Name of file's subversion\n   * @summary Returns downloadable URL to File\n   * @returns {String}\n   */\n  link(version = 'original') {\n    this._collection._debug(`[FilesCollection] [FileCursor] [link(${version})]`);\n    if (this._fileRef) {\n      return this._collection.link(this._fileRef, version);\n    }\n    return '';\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FileCursor\n   * @name get\n   * @param property {String} - Name of sub-object property\n   * @summary Returns current document as a plain Object, if `property` is specified - returns value of sub-object property\n   * @returns {Object|mix}\n   */\n  get(property) {\n    this._collection._debug(`[FilesCollection] [FileCursor] [get(${property})]`);\n    if (property) {\n      return this._fileRef[property];\n    }\n    return this._fileRef;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FileCursor\n   * @name fetch\n   * @summary Returns document as plain Object in Array\n   * @returns {[Object]}\n   */\n  fetch() {\n    this._collection._debug('[FilesCollection] [FileCursor] [fetch()]');\n    return [this._fileRef];\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FileCursor\n   * @name with\n   * @summary Returns reactive version of current FileCursor, useful to use with `{{#with}}...{{/with}}` block template helper\n   * @returns {[Object]}\n   */\n  with() {\n    this._collection._debug('[FilesCollection] [FileCursor] [with()]');\n    return _.extend(this, this._collection.collection.findOne(this._fileRef._id));\n  }\n}\n\n/*\n * @private\n * @locus Anywhere\n * @class FilesCursor\n * @param _selector   {String|Object}   - Mongo-Style selector (http://docs.meteor.com/api/collections.html#selectors)\n * @param options     {Object}          - Mongo-Style selector Options (http://docs.meteor.com/api/collections.html#selectors)\n * @param _collection {FilesCollection} - FilesCollection Instance\n * @summary Implementation of Cursor for FilesCollection\n */\nexport class FilesCursor {\n  constructor(_selector = {}, options, _collection) {\n    this._collection = _collection;\n    this._selector   = _selector;\n    this._current    = -1;\n    this.cursor      = this._collection.collection.find(this._selector, options);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name get\n   * @summary Returns all matching document(s) as an Array. Alias of `.fetch()`\n   * @returns {[Object]}\n   */\n  get() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [get()]');\n    return this.cursor.fetch();\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name hasNext\n   * @summary Returns `true` if there is next item available on Cursor\n   * @returns {Boolean}\n   */\n  hasNext() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [hasNext()]');\n    return this._current < (this.cursor.count() - 1);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name next\n   * @summary Returns next item on Cursor, if available\n   * @returns {Object|undefined}\n   */\n  next() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [next()]');\n    this.cursor.fetch()[++this._current];\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name hasPrevious\n   * @summary Returns `true` if there is previous item available on Cursor\n   * @returns {Boolean}\n   */\n  hasPrevious() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [hasPrevious()]');\n    return this._current !== -1;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name previous\n   * @summary Returns previous item on Cursor, if available\n   * @returns {Object|undefined}\n   */\n  previous() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [previous()]');\n    this.cursor.fetch()[--this._current];\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name fetch\n   * @summary Returns all matching document(s) as an Array.\n   * @returns {[Object]}\n   */\n  fetch() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [fetch()]');\n    return this.cursor.fetch() || [];\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name first\n   * @summary Returns first item on Cursor, if available\n   * @returns {Object|undefined}\n   */\n  first() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [first()]');\n    this._current = 0;\n    return this.fetch()[this._current];\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name last\n   * @summary Returns last item on Cursor, if available\n   * @returns {Object|undefined}\n   */\n  last() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [last()]');\n    this._current = this.count() - 1;\n    return this.fetch()[this._current];\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name count\n   * @summary Returns the number of documents that match a query\n   * @returns {Number}\n   */\n  count() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [count()]');\n    return this.cursor.count();\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name remove\n   * @param callback {Function} - Triggered asynchronously after item is removed or failed to be removed\n   * @summary Removes all documents that match a query\n   * @returns {FilesCursor}\n   */\n  remove(callback) {\n    this._collection._debug('[FilesCollection] [FilesCursor] [remove()]');\n    this._collection.remove(this._selector, callback);\n    return this;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name forEach\n   * @param callback {Function} - Function to call. It will be called with three arguments: the `file`, a 0-based index, and cursor itself\n   * @param context {Object} - An object which will be the value of `this` inside `callback`\n   * @summary Call `callback` once for each matching document, sequentially and synchronously.\n   * @returns {undefined}\n   */\n  forEach(callback, context = {}) {\n    this._collection._debug('[FilesCollection] [FilesCursor] [forEach()]');\n    this.cursor.forEach(callback, context);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name each\n   * @summary Returns an Array of FileCursor made for each document on current cursor\n   *          Useful when using in {{#each FilesCursor#each}}...{{/each}} block template helper\n   * @returns {[FileCursor]}\n   */\n  each() {\n    return this.map((file) => {\n      return new FileCursor(file, this._collection);\n    });\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name map\n   * @param callback {Function} - Function to call. It will be called with three arguments: the `file`, a 0-based index, and cursor itself\n   * @param context {Object} - An object which will be the value of `this` inside `callback`\n   * @summary Map `callback` over all matching documents. Returns an Array.\n   * @returns {Array}\n   */\n  map(callback, context = {}) {\n    this._collection._debug('[FilesCollection] [FilesCursor] [map()]');\n    return this.cursor.map(callback, context);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name current\n   * @summary Returns current item on Cursor, if available\n   * @returns {Object|undefined}\n   */\n  current() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [current()]');\n    if (this._current < 0) {\n      this._current = 0;\n    }\n    return this.fetch()[this._current];\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name observe\n   * @param callbacks {Object} - Functions to call to deliver the result set as it changes\n   * @summary Watch a query. Receive callbacks as the result set changes.\n   * @url http://docs.meteor.com/api/collections.html#Mongo-Cursor-observe\n   * @returns {Object} - live query handle\n   */\n  observe(callbacks) {\n    this._collection._debug('[FilesCollection] [FilesCursor] [observe()]');\n    return this.cursor.observe(callbacks);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name observeChanges\n   * @param callbacks {Object} - Functions to call to deliver the result set as it changes\n   * @summary Watch a query. Receive callbacks as the result set changes. Only the differences between the old and new documents are passed to the callbacks.\n   * @url http://docs.meteor.com/api/collections.html#Mongo-Cursor-observeChanges\n   * @returns {Object} - live query handle\n   */\n  observeChanges(callbacks) {\n    this._collection._debug('[FilesCollection] [FilesCursor] [observeChanges()]');\n    return this.cursor.observeChanges(callbacks);\n  }\n}\n","import { _ }     from 'meteor/underscore';\nimport { check } from 'meteor/check';\n\n/*\n * @const {Function} fixJSONParse - Fix issue with Date parse\n */\nconst fixJSONParse = function(obj) {\n  for (let key in obj) {\n    if (_.isString(obj[key]) && !!~obj[key].indexOf('=--JSON-DATE--=')) {\n      obj[key] = obj[key].replace('=--JSON-DATE--=', '');\n      obj[key] = new Date(parseInt(obj[key]));\n    } else if (_.isObject(obj[key])) {\n      obj[key] = fixJSONParse(obj[key]);\n    } else if (_.isArray(obj[key])) {\n      let v;\n      for (let i = 0; i < obj[key].length; i++) {\n        v = obj[key][i];\n        if (_.isObject(v)) {\n          obj[key][i] = fixJSONParse(v);\n        } else if (_.isString(v) && !!~v.indexOf('=--JSON-DATE--=')) {\n          v = v.replace('=--JSON-DATE--=', '');\n          obj[key][i] = new Date(parseInt(v));\n        }\n      }\n    }\n  }\n  return obj;\n};\n\n/*\n * @const {Function} fixJSONStringify - Fix issue with Date stringify\n */\nconst fixJSONStringify = function(obj) {\n  for (let key in obj) {\n    if (_.isDate(obj[key])) {\n      obj[key] = `=--JSON-DATE--=${+obj[key]}`;\n    } else if (_.isObject(obj[key])) {\n      obj[key] = fixJSONStringify(obj[key]);\n    } else if (_.isArray(obj[key])) {\n      let v;\n      for (let i = 0; i < obj[key].length; i++) {\n        v = obj[key][i];\n        if (_.isObject(v)) {\n          obj[key][i] = fixJSONStringify(v);\n        } else if (_.isDate(v)) {\n          obj[key][i] = `=--JSON-DATE--=${+v}`;\n        }\n      }\n    }\n  }\n  return obj;\n};\n\n/*\n * @locus Anywhere\n * @private\n * @name formatFleURL\n * @param {Object} fileRef - File reference object\n * @param {String} version - [Optional] Version of file you would like build URL for\n * @summary Returns formatted URL for file\n * @returns {String} Downloadable link\n */\nconst formatFleURL = (fileRef, version = 'original') => {\n  let ext;\n  check(fileRef, Object);\n  check(version, String);\n\n  const _root = __meteor_runtime_config__.ROOT_URL.replace(/\\/+$/, '');\n  const vRef = ((fileRef.versions && fileRef.versions[version]) || fileRef);\n\n  if (vRef.extension && _.isString(vRef, 'extension')) {\n    ext = `.${vRef.extension.replace(/^\\./, '')}`;\n  } else {\n    ext = '';\n  }\n\n  if (fileRef.public === true) {\n    return _root + (version === 'original' ? `${fileRef._downloadRoute}/${fileRef._id}${ext}` : `${fileRef._downloadRoute}/${version}-${fileRef._id}${ext}`);\n  }\n  return _root + `${fileRef._downloadRoute}/${fileRef._collectionName}/${fileRef._id}/${version}/${fileRef._id}${ext}`;\n};\n\nexport { fixJSONParse, fixJSONStringify, formatFleURL };\n","import { _ }            from 'meteor/underscore';\nimport { HTTP }         from 'meteor/http';\nimport { Meteor }       from 'meteor/meteor';\nimport { Random }       from 'meteor/random';\nimport { Tracker }      from 'meteor/tracker';\nimport { ReactiveVar }  from 'meteor/reactive-var';\nimport { EventEmitter } from 'eventemitter3';\nimport { check, Match } from 'meteor/check';\nimport { fixJSONParse, fixJSONStringify } from './lib.js';\n\nconst isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);\n\n/*\n * @locus Client\n * @name UploadInstance\n * @class UploadInstance\n * @summary Internal Class, used for file upload\n */\nexport class UploadInstance extends EventEmitter {\n  constructor(config, collection) {\n    super();\n    this.config     = config;\n    this.collection = collection;\n    this.collection._debug('[FilesCollection] [insert()]');\n\n    if (!this.config.ddp) {\n      this.config.ddp = this.collection.ddp;\n    }\n\n    if (!this.config.meta) {\n      this.config.meta = {};\n    }\n\n    if (!this.config.streams) {\n      this.config.streams = 2;\n    }\n\n    if (this.config.streams < 1) {\n      this.config.streams = 2;\n    }\n\n    if (!_.isString(this.config.transport)) {\n      this.config.transport = 'ddp';\n    }\n\n    this.config.transport = this.config.transport.toLowerCase();\n\n    if (this.config.transport !== 'ddp' && this.config.transport !== 'http') {\n      this.config.transport = 'ddp';\n    }\n\n    if (!this.config.chunkSize) {\n      this.config.chunkSize = this.collection.chunkSize;\n    }\n\n    if (!_.isBoolean(this.config.allowWebWorkers)) {\n      this.config.allowWebWorkers = true;\n    }\n\n    check(this.config, {\n      ddp: Match.Any,\n      file: Match.Any,\n      meta: Match.Optional(Object),\n      type: Match.Optional(String),\n      onError: Match.Optional(Function),\n      onAbort: Match.Optional(Function),\n      streams: Match.OneOf('dynamic', Number),\n      onStart: Match.Optional(Function),\n      fileName: Match.Optional(String),\n      isBase64: Match.Optional(Boolean),\n      transport: Match.OneOf('http', 'ddp'),\n      chunkSize: Match.OneOf('dynamic', Number),\n      onUploaded: Match.Optional(Function),\n      onProgress: Match.Optional(Function),\n      onBeforeUpload: Match.Optional(Function),\n      allowWebWorkers: Boolean\n    });\n\n    if (this.config.isBase64 === true) {\n      check(this.config.file, String);\n\n      if (!this.config.fileName) {\n        throw new Meteor.Error(400, '\"fileName\" must me specified for base64 upload!');\n      }\n\n      if (!!~this.config.file.indexOf('data:')) {\n        this.config.file = this.config.file.replace('data:', '');\n      }\n\n      if (!!~this.config.file.indexOf(',')) {\n        const _file = this.config.file.split(',');\n        this.fileData = {\n          size: Math.floor(((_file[1].replace(/\\=/g, '')).length / 4) * 3),\n          type: _file[0].split(';')[0],\n          name: this.config.fileName,\n          meta: this.config.meta\n        };\n        this.config.file = _file[1];\n      } else if (!this.config.type) {\n        throw new Meteor.Error(400, '\"type\" must me specified for base64 upload! And represent mime-type of the file');\n      } else {\n        this.fileData = {\n          size: Math.floor(((this.config.file.replace(/\\=/g, '')).length / 4) * 3),\n          type: this.config.type,\n          name: this.config.fileName,\n          meta: this.config.meta\n        };\n      }\n    }\n\n    if (this.config.file) {\n      if (!this.config.isBase64) {\n        try {\n          if (!this.config.file.name || !this.config.file.size) {\n            throw new Meteor.Error(500, 'Not a File!');\n          }\n        } catch (e) {\n          throw new Meteor.Error(500, '[FilesCollection] [insert] Insert method accepts File, not a FileList. You need to provide a real File. File must have `.name` property, and its size must be larger than zero.');\n        }\n\n        this.fileData = {\n          size: this.config.file.size,\n          type: this.config.type || this.config.file.type,\n          name: this.config.fileName || this.config.file.name,\n          meta: this.config.meta\n        };\n      }\n\n      if (this.collection.debug) {\n        console.time(`insert ${this.fileData.name}`);\n        console.time(`loadFile ${this.fileData.name}`);\n      }\n\n      if (this.collection._supportWebWorker && this.config.allowWebWorkers) {\n        try {\n          this.worker = new Worker(this.collection._webWorkerUrl);\n        } catch (wwError) {\n          this.worker = false;\n          this.collection._debug('[FilesCollection] [insert] [create WebWorker]: Can\\'t create WebWorker, fallback to MainThread', wwError);\n        }\n      } else {\n        this.worker = null;\n      }\n\n      this.startTime     = {};\n      this.config.debug  = this.collection.debug;\n      this.config._debug = this.collection._debug;\n      this.currentChunk  = 0;\n      this.transferTime  = 0;\n      this.trackerComp   = null;\n      this.sentChunks    = 0;\n      this.fileLength    = 1;\n      this.EOFsent       = false;\n      this.fileId        = Random.id();\n      this.FSName        = this.collection.namingFunction ? this.collection.namingFunction(this.fileData) : this.fileId;\n      this.pipes         = [];\n\n      this.fileData = _.extend(this.fileData, this.collection._getExt(this.fileData.name), {mime: this.collection._getMimeType(this.fileData)});\n      this.fileData['mime-type'] = this.fileData.mime;\n\n      this.result = new FileUpload(_.extend(this.config, {\n        fileData: this.fileData,\n        fileId: this.fileId,\n        _Abort: this.collection._methodNames._Abort\n      }));\n\n      this.beforeunload = (e) => {\n        const message = _.isFunction(this.collection.onbeforeunloadMessage) ? this.collection.onbeforeunloadMessage.call(this.result, this.fileData) : this.collection.onbeforeunloadMessage;\n\n        if (e) {\n          e.returnValue = message;\n        }\n        return message;\n      };\n\n      this.result.config.beforeunload = this.beforeunload;\n      window.addEventListener('beforeunload', this.beforeunload, false);\n\n      this.result.config._onEnd = () => this.emit('_onEnd');\n\n      this.addListener('end', this.end);\n      this.addListener('start', this.start);\n      this.addListener('upload', this.upload);\n      this.addListener('sendEOF', this.sendEOF);\n      this.addListener('prepare', this.prepare);\n      this.addListener('sendChunk', this.sendChunk);\n      this.addListener('proceedChunk', this.proceedChunk);\n      this.addListener('createStreams', this.createStreams);\n\n      this.addListener('calculateStats', _.throttle(() => {\n        const _t = (this.transferTime / this.sentChunks) / this.config.streams;\n        this.result.estimateTime.set((_t * (this.fileLength - this.sentChunks)));\n        this.result.estimateSpeed.set((this.config.chunkSize / (_t / 1000)));\n\n        const progress = Math.round((this.sentChunks / this.fileLength) * 100);\n        this.result.progress.set(progress);\n        this.config.onProgress && this.config.onProgress.call(this.result, progress, this.fileData);\n        this.result.emit('progress', progress, this.fileData);\n      }, 250));\n\n      this.addListener('_onEnd', () => {\n        if (this.result.estimateTimer) {\n          Meteor.clearInterval(this.result.estimateTimer);\n        }\n        if (this.worker) {\n          this.worker.terminate();\n        }\n        if (this.trackerComp) {\n          this.trackerComp.stop();\n        }\n        if (this.beforeunload) {\n          window.removeEventListener('beforeunload', this.beforeunload, false);\n        }\n        if (this.result) {\n          return this.result.progress.set(0);\n        }\n        return void 0;\n      });\n    } else {\n      throw new Meteor.Error(500, '[FilesCollection] [insert] Have you forget to pass a File itself?');\n    }\n  }\n\n  end(error, data) {\n    this.collection._debug('[FilesCollection] [UploadInstance] [end]', this.fileData.name);\n    if (this.collection.debug) {\n      console.timeEnd(`insert ${this.fileData.name}`);\n    }\n\n    this.emit('_onEnd');\n    this.result.emit('uploaded', error, data);\n    this.config.onUploaded && this.config.onUploaded.call(this.result, error, data);\n\n    if (error) {\n      this.collection._debug('[FilesCollection] [insert] [end] Error:', error);\n      this.result.abort();\n      this.result.state.set('aborted');\n      this.result.emit('error', error, this.fileData);\n      this.config.onError && this.config.onError.call(this.result, error, this.fileData);\n    } else {\n      this.result.state.set('completed');\n      this.collection.emit('afterUpload', data);\n    }\n    this.result.emit('end', error, (data || this.fileData));\n    return this.result;\n  }\n\n  sendChunk(evt) {\n    const opts = {\n      fileId: this.fileId,\n      binData: evt.data.bin,\n      chunkId: evt.data.chunkId\n    };\n\n    if (this.config.isBase64) {\n      const pad = opts.binData.length % 4;\n      if (pad) {\n        let p = 0;\n        while (p < pad) {\n          opts.binData += '=';\n          p++;\n        }\n      }\n    }\n\n    this.emit('data', evt.data.bin);\n    if (this.pipes.length) {\n      for (let i = this.pipes.length - 1; i >= 0; i--) {\n        opts.binData = this.pipes[i](opts.binData);\n      }\n    }\n\n    if (this.fileLength === evt.data.chunkId) {\n      if (this.collection.debug) {\n        console.timeEnd(`loadFile ${this.fileData.name}`);\n      }\n      this.emit('readEnd');\n    }\n\n    if (opts.binData) {\n      if (this.config.transport === 'ddp') {\n        this.config.ddp.call(this.collection._methodNames._Write, opts, (error) => {\n          this.transferTime += (+new Date) - this.startTime[opts.chunkId];\n          if (error) {\n            if (this.result.state.get() !== 'aborted') {\n              this.emit('end', error);\n            }\n          } else {\n            ++this.sentChunks;\n            if (this.sentChunks >= this.fileLength) {\n              this.emit('sendEOF');\n            } else if (this.currentChunk < this.fileLength) {\n              this.emit('upload');\n            }\n            this.emit('calculateStats');\n          }\n        });\n      } else {\n        HTTP.call('POST', `${this.collection.downloadRoute}/${this.collection.collectionName}/__upload`, {\n          content: opts.binData,\n          headers: {\n            'x-mtok': (_.isObject(Meteor.connection) ? Meteor.connection._lastSessionId : undefined) || null,\n            'x-fileid': opts.fileId,\n            'x-chunkid': opts.chunkId,\n            'content-type': 'text/plain'\n          }\n        }, (error) => {\n          this.transferTime += +new Date() - this.startTime[opts.chunkId];\n          if (error) {\n            if (`${error}` === 'Error: network') {\n              this.result.pause();\n            } else {\n              if (this.result.state.get() !== 'aborted') {\n                this.emit('end', error);\n              }\n            }\n          } else {\n            ++this.sentChunks;\n            if (this.sentChunks >= this.fileLength) {\n              this.emit('sendEOF');\n            } else if (this.currentChunk < this.fileLength) {\n              this.emit('upload');\n            }\n            this.emit('calculateStats');\n          }\n        });\n      }\n    }\n  }\n\n  sendEOF() {\n    this.collection._debug('[FilesCollection] [UploadInstance] [sendEOF]', this.EOFsent);\n    if (!this.EOFsent) {\n      this.EOFsent = true;\n      const opts = {\n        eof: true,\n        fileId: this.fileId\n      };\n\n      if (this.config.transport === 'ddp') {\n        this.config.ddp.call(this.collection._methodNames._Write, opts, (error, result) => {\n          this.emit('end', error, result);\n        });\n      } else {\n        HTTP.call('POST', `${this.collection.downloadRoute}/${this.collection.collectionName}/__upload`, {\n          content: '',\n          headers: {\n            'x-eof': '1',\n            'x-mtok': (_.isObject(Meteor.connection) ? Meteor.connection._lastSessionId : undefined) || null,\n            'x-fileId': opts.fileId,\n            'content-type': 'text/plain'\n          }\n        }, (error, _result) => {\n          let result;\n          try {\n            result = JSON.parse((_.isObject(_result) ? _result.content : undefined) || {});\n          } catch (e) {\n            console.warn('Something went wrong! [sendEOF] method doesn\\'t returned JSON! Looks like you\\'re on Cordova app or behind proxy, switching to DDP transport is recommended.');\n            result = {};\n          }\n\n          if (result.meta) {\n            result.meta = fixJSONParse(result.meta);\n          }\n\n          this.emit('end', error, result);\n        });\n      }\n    }\n  }\n\n  proceedChunk(chunkId) {\n    const chunk = this.config.file.slice((this.config.chunkSize * (chunkId - 1)), (this.config.chunkSize * chunkId));\n\n    if (this.config.isBase64) {\n      this.emit('sendChunk', {\n        data: {\n          bin: chunk,\n          chunkId\n        }\n      });\n    } else {\n      let fileReader;\n      if (FileReader) {\n        fileReader = new FileReader;\n\n        fileReader.onloadend = (evt) => {\n          this.emit('sendChunk', {\n            data: {\n              bin: ((_.isObject(fileReader) ? fileReader.result : undefined) || (evt.srcElement ? evt.srcElement.result : undefined) || (evt.target ? evt.target.result : undefined)).split(',')[1],\n              chunkId\n            }\n          });\n        };\n\n        fileReader.onerror = (e) => {\n          this.emit('end', (e.target || e.srcElement).error);\n        };\n\n        fileReader.readAsDataURL(chunk);\n      } else if (FileReaderSync) {\n        fileReader = new FileReaderSync;\n\n        this.emit('sendChunk', {\n          data: {\n            bin: fileReader.readAsDataURL(chunk).split(',')[1],\n            chunkId\n          }\n        });\n      } else {\n        this.emit('end', 'File API is not supported in this Browser!');\n      }\n    }\n  }\n\n  upload() {\n    if (this.result.onPause.get()) {\n      return this;\n    }\n\n    if (this.result.state.get() === 'aborted') {\n      return this;\n    }\n\n    if (this.currentChunk <= this.fileLength) {\n      ++this.currentChunk;\n      if (this.worker) {\n        this.worker.postMessage({\n          f: this.config.file,\n          sc: this.sentChunks,\n          cc: this.currentChunk,\n          cs: this.config.chunkSize,\n          ib: this.config.isBase64\n        });\n      } else {\n        this.emit('proceedChunk', this.currentChunk);\n      }\n    } else {\n      this.emit('sendEOF');\n    }\n    this.startTime[this.currentChunk] = +new Date();\n    return this;\n  }\n\n  createStreams() {\n    this.collection._debug('[FilesCollection] [UploadInstance] [createStreams]');\n    let i = 1;\n    while (i <= this.config.streams) {\n      this.emit('upload');\n      i++;\n    }\n  }\n\n  prepare() {\n    let _len;\n\n    this.config.onStart && this.config.onStart.call(this.result, null, this.fileData);\n    this.result.emit('start', null, this.fileData);\n\n    if (this.config.chunkSize === 'dynamic') {\n      this.config.chunkSize = this.fileData.size / 1000;\n      if (this.config.chunkSize < 327680) {\n        this.config.chunkSize = 327680;\n      } else if (this.config.chunkSize > 1048576) {\n        this.config.chunkSize = 1048576;\n      }\n\n      if (this.config.transport === 'http') {\n        this.config.chunkSize = Math.round(this.config.chunkSize / 2);\n      } else if (isSafari) {\n        this.config.chunkSize = Math.ceil(this.config.chunkSize / 8);\n      }\n    }\n\n    if (this.config.isBase64) {\n      this.config.chunkSize = Math.floor(this.config.chunkSize / 4) * 4;\n      _len = Math.ceil(this.config.file.length / this.config.chunkSize);\n    } else {\n      this.config.chunkSize = Math.floor(this.config.chunkSize / 8) * 8;\n      _len = Math.ceil(this.fileData.size / this.config.chunkSize);\n    }\n\n    if (this.config.streams === 'dynamic') {\n      this.config.streams = _.clone(_len);\n      if (this.config.streams > 24) { this.config.streams = 24; }\n\n      if (this.config.transport === 'http') {\n        this.config.streams = Math.round(this.config.streams / 2);\n      } else if (isSafari) {\n        this.config.streams = 1;\n      }\n    }\n\n    this.fileLength = _len <= 0 ? 1 : _len;\n    if (this.config.streams > this.fileLength) {\n      this.config.streams = this.fileLength;\n    }\n    this.result.config.fileLength = this.fileLength;\n\n    const opts = {\n      file: this.fileData,\n      fileId: this.fileId,\n      chunkSize: this.config.isBase64 ? ((this.config.chunkSize  / 4) * 3) : this.config.chunkSize,\n      fileLength: this.fileLength\n    };\n\n    if (this.FSName !== this.fileId) {\n      opts.FSName = this.FSName;\n    }\n\n    const handleStart = (error) => {\n      if (error) {\n        this.collection._debug('[FilesCollection] [_Start] Error:', error);\n        this.emit('end', error);\n      } else {\n        this.result.continueFunc = () => {\n          this.collection._debug('[FilesCollection] [insert] [continueFunc]');\n          this.emit('createStreams');\n        };\n        this.emit('createStreams');\n      }\n    };\n\n    if (this.config.transport === 'ddp') {\n      this.config.ddp.call(this.collection._methodNames._Start, opts, handleStart);\n    } else {\n      if (_.isObject(opts.file) ? opts.file.meta : undefined) {\n        opts.file.meta = fixJSONStringify(opts.file.meta);\n      }\n\n      HTTP.call('POST', `${this.collection.downloadRoute}/${this.collection.collectionName}/__upload`, {\n        data: opts,\n        headers: {\n          'x-start': '1',\n          'x-mtok': (_.isObject(Meteor.connection) ? Meteor.connection._lastSessionId : undefined) || null\n        }\n      }, handleStart);\n    }\n  }\n\n  pipe(func) {\n    this.pipes.push(func);\n    return this;\n  }\n\n  start() {\n    let isUploadAllowed;\n    if (this.fileData.size <= 0) {\n      this.end(new Meteor.Error(400, 'Can\\'t upload empty file'));\n      return this.result;\n    }\n\n    if (this.config.onBeforeUpload && _.isFunction(this.config.onBeforeUpload)) {\n      isUploadAllowed = this.config.onBeforeUpload.call(_.extend(this.result, this.collection._getUser()), this.fileData);\n      if (isUploadAllowed !== true) {\n        return this.end(new Meteor.Error(403, _.isString(isUploadAllowed) ? isUploadAllowed : 'config.onBeforeUpload() returned false'));\n      }\n    }\n\n    if (this.collection.onBeforeUpload && _.isFunction(this.collection.onBeforeUpload)) {\n      isUploadAllowed = this.collection.onBeforeUpload.call(_.extend(this.result, this.collection._getUser()), this.fileData);\n      if (isUploadAllowed !== true) {\n        return this.end(new Meteor.Error(403, _.isString(isUploadAllowed) ? isUploadAllowed : 'collection.onBeforeUpload() returned false'));\n      }\n    }\n\n    Tracker.autorun((computation) => {\n      this.trackerComp = computation;\n      if (!this.result.onPause.curValue && !Meteor.status().connected) {\n        this.collection._debug('[FilesCollection] [insert] [Tracker] [pause]');\n        this.result.pause();\n      }\n    });\n\n    if (this.worker) {\n      this.collection._debug('[FilesCollection] [insert] using WebWorkers');\n      this.worker.onmessage = (evt) => {\n        if (evt.data.error) {\n          this.collection._debug('[FilesCollection] [insert] [worker] [onmessage] [ERROR:]', evt.data.error);\n          this.emit('proceedChunk', evt.data.chunkId);\n        } else {\n          this.emit('sendChunk', evt);\n        }\n      };\n\n      this.worker.onerror = (e) => {\n        this.collection._debug('[FilesCollection] [insert] [worker] [onerror] [ERROR:]', e);\n        this.emit('end', e.message);\n      };\n    } else {\n      this.collection._debug('[FilesCollection] [insert] using MainThread');\n    }\n\n    this.emit('prepare');\n    return this.result;\n  }\n\n  manual() {\n    this.result.start = () => {\n      this.emit('start');\n    };\n\n    this.result.pipe = function (func) {\n      self.pipe(func);\n      return this;\n    };\n    return this.result;\n  }\n}\n\n/*\n * @locus Client\n * @name FileUpload\n * @class FileUpload\n * @summary Internal Class, instance of this class is returned from `.insert()` method\n */\nexport class FileUpload extends EventEmitter {\n  constructor(config) {\n    super();\n    this.config = config;\n    this.config._debug('[FilesCollection] [FileUpload] [constructor]');\n\n    if (!this.config.isBase64) {\n      this.file        = _.extend(this.config.file, this.config.fileData);\n    } else {\n      this.file        = this.config.fileData;\n    }\n    this.state         = new ReactiveVar('active');\n    this.onPause       = new ReactiveVar(false);\n    this.progress      = new ReactiveVar(0);\n    this.continueFunc  = () => { };\n    this.estimateTime  = new ReactiveVar(1000);\n    this.estimateSpeed = new ReactiveVar(0);\n    this.estimateTimer = Meteor.setInterval(() => {\n      if (this.state.get() === 'active') {\n        const _currentTime = this.estimateTime.get();\n        if (_currentTime > 1000) {\n          this.estimateTime.set(_currentTime - 1000);\n        }\n      }\n    }, 1000);\n  }\n  pause() {\n    this.config._debug('[FilesCollection] [insert] [.pause()]');\n    if (!this.onPause.get()) {\n      this.onPause.set(true);\n      this.state.set('paused');\n      this.emit('pause', this.file);\n    }\n  }\n  continue() {\n    this.config._debug('[FilesCollection] [insert] [.continue()]');\n    if (this.onPause.get()) {\n      this.onPause.set(false);\n      this.state.set('active');\n      this.emit('continue', this.file);\n      this.continueFunc();\n    }\n  }\n  toggle() {\n    this.config._debug('[FilesCollection] [insert] [.toggle()]');\n    if (this.onPause.get()) {\n      this.continue();\n    } else {\n      this.pause();\n    }\n  }\n  abort() {\n    this.config._debug('[FilesCollection] [insert] [.abort()]');\n    window.removeEventListener('beforeunload', this.config.beforeunload, false);\n    this.config.onAbort && this.config.onAbort.call(this, this.file);\n    this.emit('abort', this.file);\n    this.pause();\n    this.config._onEnd();\n    this.state.set('aborted');\n    if (this.config.debug) {\n      console.timeEnd(`insert ${this.config.fileData.name}`);\n    }\n\n    this.config.ddp.call(this.config._Abort, this.config.fileId);\n  }\n}\n"]}