{"metadata":{"usedHelpers":["inherits","possibleConstructorReturn","classCallCheck","interopRequireDefault"],"marked":[],"modules":{"imports":[{"source":"meteor/underscore","imported":["_"],"specifiers":[{"kind":"named","imported":"_","local":"_"}]},{"source":"meteor/http","imported":["HTTP"],"specifiers":[{"kind":"named","imported":"HTTP","local":"HTTP"}]},{"source":"meteor/meteor","imported":["Meteor"],"specifiers":[{"kind":"named","imported":"Meteor","local":"Meteor"}]},{"source":"meteor/random","imported":["Random"],"specifiers":[{"kind":"named","imported":"Random","local":"Random"}]},{"source":"meteor/tracker","imported":["Tracker"],"specifiers":[{"kind":"named","imported":"Tracker","local":"Tracker"}]},{"source":"meteor/reactive-var","imported":["ReactiveVar"],"specifiers":[{"kind":"named","imported":"ReactiveVar","local":"ReactiveVar"}]},{"source":"eventemitter3","imported":["EventEmitter"],"specifiers":[{"kind":"named","imported":"EventEmitter","local":"EventEmitter"}]},{"source":"meteor/check","imported":["check","Match"],"specifiers":[{"kind":"named","imported":"check","local":"check"},{"kind":"named","imported":"Match","local":"Match"}]},{"source":"./lib.js","imported":["fixJSONParse","fixJSONStringify"],"specifiers":[{"kind":"named","imported":"fixJSONParse","local":"fixJSONParse"},{"kind":"named","imported":"fixJSONStringify","local":"fixJSONStringify"}]}],"exports":{"exported":["UploadInstance","FileUpload"],"specifiers":[{"kind":"local","local":"UploadInstance","exported":"UploadInstance"},{"kind":"local","local":"FileUpload","exported":"FileUpload"}]}}},"options":{"filename":"packages/ostrio:files/upload.js","filenameRelative":"packages/ostrio:files/upload.js","env":{"development":{"plugins":[]}},"retainLines":false,"highlightCode":true,"suppressDeprecationMessages":false,"presets":[],"plugins":[[[],{"generateLetDeclarations":true,"enforceStrictMode":false}],[[],null],[[],{"polyfill":false}],[[],null],[[],null],[[],null],[[],{"allowTopLevelThis":true,"strict":false,"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],{"loose":true}],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null]],"ignore":[],"code":true,"metadata":true,"ast":true,"comments":true,"compact":false,"minified":false,"sourceMap":true,"sourceMaps":true,"sourceMapTarget":"packages/ostrio:files/upload.js.map","sourceFileName":"packages/ostrio:files/upload.js","babelrc":false,"sourceType":"module","moduleIds":false,"passPerPreset":false,"parserOpts":false,"generatorOpts":false,"basename":"upload"},"ignored":false,"code":"var _classCallCheck2 = require(\"babel-runtime/helpers/classCallCheck\");\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nvar _possibleConstructorReturn2 = require(\"babel-runtime/helpers/possibleConstructorReturn\");\n\nvar _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);\n\nvar _inherits2 = require(\"babel-runtime/helpers/inherits\");\n\nvar _inherits3 = _interopRequireDefault(_inherits2);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { \"default\": obj }; }\n\nmodule.export({\n  UploadInstance: function () {\n    return UploadInstance;\n  },\n  FileUpload: function () {\n    return FileUpload;\n  }\n});\n\nvar _ = void 0;\n\nmodule.watch(require(\"meteor/underscore\"), {\n  _: function (v) {\n    _ = v;\n  }\n}, 0);\nvar HTTP = void 0;\nmodule.watch(require(\"meteor/http\"), {\n  HTTP: function (v) {\n    HTTP = v;\n  }\n}, 1);\nvar Meteor = void 0;\nmodule.watch(require(\"meteor/meteor\"), {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 2);\nvar Random = void 0;\nmodule.watch(require(\"meteor/random\"), {\n  Random: function (v) {\n    Random = v;\n  }\n}, 3);\nvar Tracker = void 0;\nmodule.watch(require(\"meteor/tracker\"), {\n  Tracker: function (v) {\n    Tracker = v;\n  }\n}, 4);\nvar ReactiveVar = void 0;\nmodule.watch(require(\"meteor/reactive-var\"), {\n  ReactiveVar: function (v) {\n    ReactiveVar = v;\n  }\n}, 5);\nvar EventEmitter = void 0;\nmodule.watch(require(\"eventemitter3\"), {\n  EventEmitter: function (v) {\n    EventEmitter = v;\n  }\n}, 6);\nvar check = void 0,\n    Match = void 0;\nmodule.watch(require(\"meteor/check\"), {\n  check: function (v) {\n    check = v;\n  },\n  Match: function (v) {\n    Match = v;\n  }\n}, 7);\nvar fixJSONParse = void 0,\n    fixJSONStringify = void 0;\nmodule.watch(require(\"./lib.js\"), {\n  fixJSONParse: function (v) {\n    fixJSONParse = v;\n  },\n  fixJSONStringify: function (v) {\n    fixJSONStringify = v;\n  }\n}, 8);\nvar isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent); /*\n                                                                            * @locus Client\n                                                                            * @name UploadInstance\n                                                                            * @class UploadInstance\n                                                                            * @summary Internal Class, used for file upload\n                                                                            */\n\nvar UploadInstance = function (_EventEmitter) {\n  (0, _inherits3.default)(UploadInstance, _EventEmitter);\n\n  function UploadInstance(config, collection) {\n    (0, _classCallCheck3.default)(this, UploadInstance);\n\n    var _this = (0, _possibleConstructorReturn3.default)(this, _EventEmitter.call(this));\n\n    _this.config = config;\n    _this.collection = collection;\n\n    _this.collection._debug('[FilesCollection] [insert()]');\n\n    if (!_this.config.ddp) {\n      _this.config.ddp = _this.collection.ddp;\n    }\n\n    if (!_this.config.meta) {\n      _this.config.meta = {};\n    }\n\n    if (!_this.config.streams) {\n      _this.config.streams = 2;\n    }\n\n    if (_this.config.streams < 1) {\n      _this.config.streams = 2;\n    }\n\n    if (!_.isString(_this.config.transport)) {\n      _this.config.transport = 'ddp';\n    }\n\n    _this.config.transport = _this.config.transport.toLowerCase();\n\n    if (_this.config.transport !== 'ddp' && _this.config.transport !== 'http') {\n      _this.config.transport = 'ddp';\n    }\n\n    if (!_this.config.chunkSize) {\n      _this.config.chunkSize = _this.collection.chunkSize;\n    }\n\n    if (!_.isBoolean(_this.config.allowWebWorkers)) {\n      _this.config.allowWebWorkers = true;\n    }\n\n    check(_this.config, {\n      ddp: Match.Any,\n      file: Match.Any,\n      meta: Match.Optional(Object),\n      type: Match.Optional(String),\n      onError: Match.Optional(Function),\n      onAbort: Match.Optional(Function),\n      streams: Match.OneOf('dynamic', Number),\n      onStart: Match.Optional(Function),\n      fileName: Match.Optional(String),\n      isBase64: Match.Optional(Boolean),\n      transport: Match.OneOf('http', 'ddp'),\n      chunkSize: Match.OneOf('dynamic', Number),\n      onUploaded: Match.Optional(Function),\n      onProgress: Match.Optional(Function),\n      onBeforeUpload: Match.Optional(Function),\n      allowWebWorkers: Boolean\n    });\n\n    if (_this.config.isBase64 === true) {\n      check(_this.config.file, String);\n\n      if (!_this.config.fileName) {\n        throw new Meteor.Error(400, '\"fileName\" must me specified for base64 upload!');\n      }\n\n      if (!!~_this.config.file.indexOf('data:')) {\n        _this.config.file = _this.config.file.replace('data:', '');\n      }\n\n      if (!!~_this.config.file.indexOf(',')) {\n        var _file = _this.config.file.split(',');\n\n        _this.fileData = {\n          size: Math.floor(_file[1].replace(/\\=/g, '').length / 4 * 3),\n          type: _file[0].split(';')[0],\n          name: _this.config.fileName,\n          meta: _this.config.meta\n        };\n        _this.config.file = _file[1];\n      } else if (!_this.config.type) {\n        throw new Meteor.Error(400, '\"type\" must me specified for base64 upload! And represent mime-type of the file');\n      } else {\n        _this.fileData = {\n          size: Math.floor(_this.config.file.replace(/\\=/g, '').length / 4 * 3),\n          type: _this.config.type,\n          name: _this.config.fileName,\n          meta: _this.config.meta\n        };\n      }\n    }\n\n    if (_this.config.file) {\n      if (!_this.config.isBase64) {\n        try {\n          if (!_this.config.file.name || !_this.config.file.size) {\n            throw new Meteor.Error(500, 'Not a File!');\n          }\n        } catch (e) {\n          throw new Meteor.Error(500, '[FilesCollection] [insert] Insert method accepts File, not a FileList. You need to provide a real File. File must have `.name` property, and its size must be larger than zero.');\n        }\n\n        _this.fileData = {\n          size: _this.config.file.size,\n          type: _this.config.type || _this.config.file.type,\n          name: _this.config.fileName || _this.config.file.name,\n          meta: _this.config.meta\n        };\n      }\n\n      if (_this.collection.debug) {\n        console.time(\"insert \" + _this.fileData.name);\n        console.time(\"loadFile \" + _this.fileData.name);\n      }\n\n      if (_this.collection._supportWebWorker && _this.config.allowWebWorkers) {\n        try {\n          _this.worker = new Worker(_this.collection._webWorkerUrl);\n        } catch (wwError) {\n          _this.worker = false;\n\n          _this.collection._debug('[FilesCollection] [insert] [create WebWorker]: Can\\'t create WebWorker, fallback to MainThread', wwError);\n        }\n      } else {\n        _this.worker = null;\n      }\n\n      _this.startTime = {};\n      _this.config.debug = _this.collection.debug;\n      _this.config._debug = _this.collection._debug;\n      _this.currentChunk = 0;\n      _this.transferTime = 0;\n      _this.trackerComp = null;\n      _this.sentChunks = 0;\n      _this.fileLength = 1;\n      _this.EOFsent = false;\n      _this.fileId = Random.id();\n      _this.FSName = _this.collection.namingFunction ? _this.collection.namingFunction(_this.fileData) : _this.fileId;\n      _this.pipes = [];\n      _this.fileData = _.extend(_this.fileData, _this.collection._getExt(_this.fileData.name), {\n        mime: _this.collection._getMimeType(_this.fileData)\n      });\n      _this.fileData['mime-type'] = _this.fileData.mime;\n      _this.result = new FileUpload(_.extend(_this.config, {\n        fileData: _this.fileData,\n        fileId: _this.fileId,\n        _Abort: _this.collection._methodNames._Abort\n      }));\n\n      _this.beforeunload = function (e) {\n        var message = _.isFunction(_this.collection.onbeforeunloadMessage) ? _this.collection.onbeforeunloadMessage.call(_this.result, _this.fileData) : _this.collection.onbeforeunloadMessage;\n\n        if (e) {\n          e.returnValue = message;\n        }\n\n        return message;\n      };\n\n      _this.result.config.beforeunload = _this.beforeunload;\n      window.addEventListener('beforeunload', _this.beforeunload, false);\n\n      _this.result.config._onEnd = function () {\n        return _this.emit('_onEnd');\n      };\n\n      _this.addListener('end', _this.end);\n\n      _this.addListener('start', _this.start);\n\n      _this.addListener('upload', _this.upload);\n\n      _this.addListener('sendEOF', _this.sendEOF);\n\n      _this.addListener('prepare', _this.prepare);\n\n      _this.addListener('sendChunk', _this.sendChunk);\n\n      _this.addListener('proceedChunk', _this.proceedChunk);\n\n      _this.addListener('createStreams', _this.createStreams);\n\n      _this.addListener('calculateStats', _.throttle(function () {\n        var _t = _this.transferTime / _this.sentChunks / _this.config.streams;\n\n        _this.result.estimateTime.set(_t * (_this.fileLength - _this.sentChunks));\n\n        _this.result.estimateSpeed.set(_this.config.chunkSize / (_t / 1000));\n\n        var progress = Math.round(_this.sentChunks / _this.fileLength * 100);\n\n        _this.result.progress.set(progress);\n\n        _this.config.onProgress && _this.config.onProgress.call(_this.result, progress, _this.fileData);\n\n        _this.result.emit('progress', progress, _this.fileData);\n      }, 250));\n\n      _this.addListener('_onEnd', function () {\n        if (_this.result.estimateTimer) {\n          Meteor.clearInterval(_this.result.estimateTimer);\n        }\n\n        if (_this.worker) {\n          _this.worker.terminate();\n        }\n\n        if (_this.trackerComp) {\n          _this.trackerComp.stop();\n        }\n\n        if (_this.beforeunload) {\n          window.removeEventListener('beforeunload', _this.beforeunload, false);\n        }\n\n        if (_this.result) {\n          return _this.result.progress.set(0);\n        }\n\n        return void 0;\n      });\n    } else {\n      throw new Meteor.Error(500, '[FilesCollection] [insert] Have you forget to pass a File itself?');\n    }\n\n    return _this;\n  }\n\n  UploadInstance.prototype.end = function () {\n    function end(error, data) {\n      this.collection._debug('[FilesCollection] [UploadInstance] [end]', this.fileData.name);\n\n      if (this.collection.debug) {\n        console.timeEnd(\"insert \" + this.fileData.name);\n      }\n\n      this.emit('_onEnd');\n      this.result.emit('uploaded', error, data);\n      this.config.onUploaded && this.config.onUploaded.call(this.result, error, data);\n\n      if (error) {\n        this.collection._debug('[FilesCollection] [insert] [end] Error:', error);\n\n        this.result.abort();\n        this.result.state.set('aborted');\n        this.result.emit('error', error, this.fileData);\n        this.config.onError && this.config.onError.call(this.result, error, this.fileData);\n      } else {\n        this.result.state.set('completed');\n        this.collection.emit('afterUpload', data);\n      }\n\n      this.result.emit('end', error, data || this.fileData);\n      return this.result;\n    }\n\n    return end;\n  }();\n\n  UploadInstance.prototype.sendChunk = function () {\n    function sendChunk(evt) {\n      var _this2 = this;\n\n      var opts = {\n        fileId: this.fileId,\n        binData: evt.data.bin,\n        chunkId: evt.data.chunkId\n      };\n\n      if (this.config.isBase64) {\n        var pad = opts.binData.length % 4;\n\n        if (pad) {\n          var p = 0;\n\n          while (p < pad) {\n            opts.binData += '=';\n            p++;\n          }\n        }\n      }\n\n      this.emit('data', evt.data.bin);\n\n      if (this.pipes.length) {\n        for (var i = this.pipes.length - 1; i >= 0; i--) {\n          opts.binData = this.pipes[i](opts.binData);\n        }\n      }\n\n      if (this.fileLength === evt.data.chunkId) {\n        if (this.collection.debug) {\n          console.timeEnd(\"loadFile \" + this.fileData.name);\n        }\n\n        this.emit('readEnd');\n      }\n\n      if (opts.binData) {\n        if (this.config.transport === 'ddp') {\n          this.config.ddp.call(this.collection._methodNames._Write, opts, function (error) {\n            _this2.transferTime += +new Date() - _this2.startTime[opts.chunkId];\n\n            if (error) {\n              if (_this2.result.state.get() !== 'aborted') {\n                _this2.emit('end', error);\n              }\n            } else {\n              ++_this2.sentChunks;\n\n              if (_this2.sentChunks >= _this2.fileLength) {\n                _this2.emit('sendEOF');\n              } else if (_this2.currentChunk < _this2.fileLength) {\n                _this2.emit('upload');\n              }\n\n              _this2.emit('calculateStats');\n            }\n          });\n        } else {\n          HTTP.call('POST', this.collection.downloadRoute + \"/\" + this.collection.collectionName + \"/__upload\", {\n            content: opts.binData,\n            headers: {\n              'x-mtok': (_.isObject(Meteor.connection) ? Meteor.connection._lastSessionId : undefined) || null,\n              'x-fileid': opts.fileId,\n              'x-chunkid': opts.chunkId,\n              'content-type': 'text/plain'\n            }\n          }, function (error) {\n            _this2.transferTime += +new Date() - _this2.startTime[opts.chunkId];\n\n            if (error) {\n              if (\"\" + error === 'Error: network') {\n                _this2.result.pause();\n              } else {\n                if (_this2.result.state.get() !== 'aborted') {\n                  _this2.emit('end', error);\n                }\n              }\n            } else {\n              ++_this2.sentChunks;\n\n              if (_this2.sentChunks >= _this2.fileLength) {\n                _this2.emit('sendEOF');\n              } else if (_this2.currentChunk < _this2.fileLength) {\n                _this2.emit('upload');\n              }\n\n              _this2.emit('calculateStats');\n            }\n          });\n        }\n      }\n    }\n\n    return sendChunk;\n  }();\n\n  UploadInstance.prototype.sendEOF = function () {\n    function sendEOF() {\n      var _this3 = this;\n\n      this.collection._debug('[FilesCollection] [UploadInstance] [sendEOF]', this.EOFsent);\n\n      if (!this.EOFsent) {\n        this.EOFsent = true;\n        var opts = {\n          eof: true,\n          fileId: this.fileId\n        };\n\n        if (this.config.transport === 'ddp') {\n          this.config.ddp.call(this.collection._methodNames._Write, opts, function (error, result) {\n            _this3.emit('end', error, result);\n          });\n        } else {\n          HTTP.call('POST', this.collection.downloadRoute + \"/\" + this.collection.collectionName + \"/__upload\", {\n            content: '',\n            headers: {\n              'x-eof': '1',\n              'x-mtok': (_.isObject(Meteor.connection) ? Meteor.connection._lastSessionId : undefined) || null,\n              'x-fileId': opts.fileId,\n              'content-type': 'text/plain'\n            }\n          }, function (error, _result) {\n            var result = void 0;\n\n            try {\n              result = JSON.parse((_.isObject(_result) ? _result.content : undefined) || {});\n            } catch (e) {\n              console.warn('Something went wrong! [sendEOF] method doesn\\'t returned JSON! Looks like you\\'re on Cordova app or behind proxy, switching to DDP transport is recommended.');\n              result = {};\n            }\n\n            if (result.meta) {\n              result.meta = fixJSONParse(result.meta);\n            }\n\n            _this3.emit('end', error, result);\n          });\n        }\n      }\n    }\n\n    return sendEOF;\n  }();\n\n  UploadInstance.prototype.proceedChunk = function () {\n    function proceedChunk(chunkId) {\n      var _this4 = this;\n\n      var chunk = this.config.file.slice(this.config.chunkSize * (chunkId - 1), this.config.chunkSize * chunkId);\n\n      if (this.config.isBase64) {\n        this.emit('sendChunk', {\n          data: {\n            bin: chunk,\n            chunkId: chunkId\n          }\n        });\n      } else {\n        var fileReader = void 0;\n\n        if (FileReader) {\n          fileReader = new FileReader();\n\n          fileReader.onloadend = function (evt) {\n            _this4.emit('sendChunk', {\n              data: {\n                bin: ((_.isObject(fileReader) ? fileReader.result : undefined) || (evt.srcElement ? evt.srcElement.result : undefined) || (evt.target ? evt.target.result : undefined)).split(',')[1],\n                chunkId: chunkId\n              }\n            });\n          };\n\n          fileReader.onerror = function (e) {\n            _this4.emit('end', (e.target || e.srcElement).error);\n          };\n\n          fileReader.readAsDataURL(chunk);\n        } else if (FileReaderSync) {\n          fileReader = new FileReaderSync();\n          this.emit('sendChunk', {\n            data: {\n              bin: fileReader.readAsDataURL(chunk).split(',')[1],\n              chunkId: chunkId\n            }\n          });\n        } else {\n          this.emit('end', 'File API is not supported in this Browser!');\n        }\n      }\n    }\n\n    return proceedChunk;\n  }();\n\n  UploadInstance.prototype.upload = function () {\n    function upload() {\n      if (this.result.onPause.get()) {\n        return this;\n      }\n\n      if (this.result.state.get() === 'aborted') {\n        return this;\n      }\n\n      if (this.currentChunk <= this.fileLength) {\n        ++this.currentChunk;\n\n        if (this.worker) {\n          this.worker.postMessage({\n            f: this.config.file,\n            sc: this.sentChunks,\n            cc: this.currentChunk,\n            cs: this.config.chunkSize,\n            ib: this.config.isBase64\n          });\n        } else {\n          this.emit('proceedChunk', this.currentChunk);\n        }\n      } else {\n        this.emit('sendEOF');\n      }\n\n      this.startTime[this.currentChunk] = +new Date();\n      return this;\n    }\n\n    return upload;\n  }();\n\n  UploadInstance.prototype.createStreams = function () {\n    function createStreams() {\n      this.collection._debug('[FilesCollection] [UploadInstance] [createStreams]');\n\n      var i = 1;\n\n      while (i <= this.config.streams) {\n        this.emit('upload');\n        i++;\n      }\n    }\n\n    return createStreams;\n  }();\n\n  UploadInstance.prototype.prepare = function () {\n    function prepare() {\n      var _this5 = this;\n\n      var _len = void 0;\n\n      this.config.onStart && this.config.onStart.call(this.result, null, this.fileData);\n      this.result.emit('start', null, this.fileData);\n\n      if (this.config.chunkSize === 'dynamic') {\n        this.config.chunkSize = this.fileData.size / 1000;\n\n        if (this.config.chunkSize < 327680) {\n          this.config.chunkSize = 327680;\n        } else if (this.config.chunkSize > 1048576) {\n          this.config.chunkSize = 1048576;\n        }\n\n        if (this.config.transport === 'http') {\n          this.config.chunkSize = Math.round(this.config.chunkSize / 2);\n        } else if (isSafari) {\n          this.config.chunkSize = Math.ceil(this.config.chunkSize / 8);\n        }\n      }\n\n      if (this.config.isBase64) {\n        this.config.chunkSize = Math.floor(this.config.chunkSize / 4) * 4;\n        _len = Math.ceil(this.config.file.length / this.config.chunkSize);\n      } else {\n        this.config.chunkSize = Math.floor(this.config.chunkSize / 8) * 8;\n        _len = Math.ceil(this.fileData.size / this.config.chunkSize);\n      }\n\n      if (this.config.streams === 'dynamic') {\n        this.config.streams = _.clone(_len);\n\n        if (this.config.streams > 24) {\n          this.config.streams = 24;\n        }\n\n        if (this.config.transport === 'http') {\n          this.config.streams = Math.round(this.config.streams / 2);\n        } else if (isSafari) {\n          this.config.streams = 1;\n        }\n      }\n\n      this.fileLength = _len <= 0 ? 1 : _len;\n\n      if (this.config.streams > this.fileLength) {\n        this.config.streams = this.fileLength;\n      }\n\n      this.result.config.fileLength = this.fileLength;\n      var opts = {\n        file: this.fileData,\n        fileId: this.fileId,\n        chunkSize: this.config.isBase64 ? this.config.chunkSize / 4 * 3 : this.config.chunkSize,\n        fileLength: this.fileLength\n      };\n\n      if (this.FSName !== this.fileId) {\n        opts.FSName = this.FSName;\n      }\n\n      var handleStart = function (error) {\n        if (error) {\n          _this5.collection._debug('[FilesCollection] [_Start] Error:', error);\n\n          _this5.emit('end', error);\n        } else {\n          _this5.result.continueFunc = function () {\n            _this5.collection._debug('[FilesCollection] [insert] [continueFunc]');\n\n            _this5.emit('createStreams');\n          };\n\n          _this5.emit('createStreams');\n        }\n      };\n\n      if (this.config.transport === 'ddp') {\n        this.config.ddp.call(this.collection._methodNames._Start, opts, handleStart);\n      } else {\n        if (_.isObject(opts.file) ? opts.file.meta : undefined) {\n          opts.file.meta = fixJSONStringify(opts.file.meta);\n        }\n\n        HTTP.call('POST', this.collection.downloadRoute + \"/\" + this.collection.collectionName + \"/__upload\", {\n          data: opts,\n          headers: {\n            'x-start': '1',\n            'x-mtok': (_.isObject(Meteor.connection) ? Meteor.connection._lastSessionId : undefined) || null\n          }\n        }, handleStart);\n      }\n    }\n\n    return prepare;\n  }();\n\n  UploadInstance.prototype.pipe = function () {\n    function pipe(func) {\n      this.pipes.push(func);\n      return this;\n    }\n\n    return pipe;\n  }();\n\n  UploadInstance.prototype.start = function () {\n    function start() {\n      var _this6 = this;\n\n      var isUploadAllowed = void 0;\n\n      if (this.fileData.size <= 0) {\n        this.end(new Meteor.Error(400, 'Can\\'t upload empty file'));\n        return this.result;\n      }\n\n      if (this.config.onBeforeUpload && _.isFunction(this.config.onBeforeUpload)) {\n        isUploadAllowed = this.config.onBeforeUpload.call(_.extend(this.result, this.collection._getUser()), this.fileData);\n\n        if (isUploadAllowed !== true) {\n          return this.end(new Meteor.Error(403, _.isString(isUploadAllowed) ? isUploadAllowed : 'config.onBeforeUpload() returned false'));\n        }\n      }\n\n      if (this.collection.onBeforeUpload && _.isFunction(this.collection.onBeforeUpload)) {\n        isUploadAllowed = this.collection.onBeforeUpload.call(_.extend(this.result, this.collection._getUser()), this.fileData);\n\n        if (isUploadAllowed !== true) {\n          return this.end(new Meteor.Error(403, _.isString(isUploadAllowed) ? isUploadAllowed : 'collection.onBeforeUpload() returned false'));\n        }\n      }\n\n      Tracker.autorun(function (computation) {\n        _this6.trackerComp = computation;\n\n        if (!_this6.result.onPause.curValue && !Meteor.status().connected) {\n          _this6.collection._debug('[FilesCollection] [insert] [Tracker] [pause]');\n\n          _this6.result.pause();\n        }\n      });\n\n      if (this.worker) {\n        this.collection._debug('[FilesCollection] [insert] using WebWorkers');\n\n        this.worker.onmessage = function (evt) {\n          if (evt.data.error) {\n            _this6.collection._debug('[FilesCollection] [insert] [worker] [onmessage] [ERROR:]', evt.data.error);\n\n            _this6.emit('proceedChunk', evt.data.chunkId);\n          } else {\n            _this6.emit('sendChunk', evt);\n          }\n        };\n\n        this.worker.onerror = function (e) {\n          _this6.collection._debug('[FilesCollection] [insert] [worker] [onerror] [ERROR:]', e);\n\n          _this6.emit('end', e.message);\n        };\n      } else {\n        this.collection._debug('[FilesCollection] [insert] using MainThread');\n      }\n\n      this.emit('prepare');\n      return this.result;\n    }\n\n    return start;\n  }();\n\n  UploadInstance.prototype.manual = function () {\n    function manual() {\n      var _this7 = this;\n\n      this.result.start = function () {\n        _this7.emit('start');\n      };\n\n      this.result.pipe = function (func) {\n        self.pipe(func);\n        return this;\n      };\n\n      return this.result;\n    }\n\n    return manual;\n  }();\n\n  return UploadInstance;\n}(EventEmitter);\n\nvar FileUpload = function (_EventEmitter2) {\n  (0, _inherits3.default)(FileUpload, _EventEmitter2);\n\n  function FileUpload(config) {\n    (0, _classCallCheck3.default)(this, FileUpload);\n\n    var _this8 = (0, _possibleConstructorReturn3.default)(this, _EventEmitter2.call(this));\n\n    _this8.config = config;\n\n    _this8.config._debug('[FilesCollection] [FileUpload] [constructor]');\n\n    if (!_this8.config.isBase64) {\n      _this8.file = _.extend(_this8.config.file, _this8.config.fileData);\n    } else {\n      _this8.file = _this8.config.fileData;\n    }\n\n    _this8.state = new ReactiveVar('active');\n    _this8.onPause = new ReactiveVar(false);\n    _this8.progress = new ReactiveVar(0);\n\n    _this8.continueFunc = function () {};\n\n    _this8.estimateTime = new ReactiveVar(1000);\n    _this8.estimateSpeed = new ReactiveVar(0);\n    _this8.estimateTimer = Meteor.setInterval(function () {\n      if (_this8.state.get() === 'active') {\n        var _currentTime = _this8.estimateTime.get();\n\n        if (_currentTime > 1000) {\n          _this8.estimateTime.set(_currentTime - 1000);\n        }\n      }\n    }, 1000);\n    return _this8;\n  }\n\n  FileUpload.prototype.pause = function () {\n    function pause() {\n      this.config._debug('[FilesCollection] [insert] [.pause()]');\n\n      if (!this.onPause.get()) {\n        this.onPause.set(true);\n        this.state.set('paused');\n        this.emit('pause', this.file);\n      }\n    }\n\n    return pause;\n  }();\n\n  FileUpload.prototype.continue = function () {\n    function _continue() {\n      this.config._debug('[FilesCollection] [insert] [.continue()]');\n\n      if (this.onPause.get()) {\n        this.onPause.set(false);\n        this.state.set('active');\n        this.emit('continue', this.file);\n        this.continueFunc();\n      }\n    }\n\n    return _continue;\n  }();\n\n  FileUpload.prototype.toggle = function () {\n    function toggle() {\n      this.config._debug('[FilesCollection] [insert] [.toggle()]');\n\n      if (this.onPause.get()) {\n        this.continue();\n      } else {\n        this.pause();\n      }\n    }\n\n    return toggle;\n  }();\n\n  FileUpload.prototype.abort = function () {\n    function abort() {\n      this.config._debug('[FilesCollection] [insert] [.abort()]');\n\n      window.removeEventListener('beforeunload', this.config.beforeunload, false);\n      this.config.onAbort && this.config.onAbort.call(this, this.file);\n      this.emit('abort', this.file);\n      this.pause();\n\n      this.config._onEnd();\n\n      this.state.set('aborted');\n\n      if (this.config.debug) {\n        console.timeEnd(\"insert \" + this.config.fileData.name);\n      }\n\n      this.config.ddp.call(this.config._Abort, this.config.fileId);\n    }\n\n    return abort;\n  }();\n\n  return FileUpload;\n}(EventEmitter);","map":{"version":3,"sources":["packages/ostrio:files/upload.js"],"names":["module","export","UploadInstance","FileUpload","_","watch","require","v","HTTP","Meteor","Random","Tracker","ReactiveVar","EventEmitter","check","Match","fixJSONParse","fixJSONStringify","isSafari","test","navigator","userAgent","config","collection","_debug","ddp","meta","streams","isString","transport","toLowerCase","chunkSize","isBoolean","allowWebWorkers","Any","file","Optional","Object","type","String","onError","Function","onAbort","OneOf","Number","onStart","fileName","isBase64","Boolean","onUploaded","onProgress","onBeforeUpload","Error","indexOf","replace","_file","split","fileData","size","Math","floor","length","name","e","debug","console","time","_supportWebWorker","worker","Worker","_webWorkerUrl","wwError","startTime","currentChunk","transferTime","trackerComp","sentChunks","fileLength","EOFsent","fileId","id","FSName","namingFunction","pipes","extend","_getExt","mime","_getMimeType","result","_Abort","_methodNames","beforeunload","message","isFunction","onbeforeunloadMessage","call","returnValue","window","addEventListener","_onEnd","emit","addListener","end","start","upload","sendEOF","prepare","sendChunk","proceedChunk","createStreams","throttle","_t","estimateTime","set","estimateSpeed","progress","round","estimateTimer","clearInterval","terminate","stop","removeEventListener","error","data","timeEnd","abort","state","evt","opts","binData","bin","chunkId","pad","p","i","_Write","Date","get","downloadRoute","collectionName","content","headers","isObject","connection","_lastSessionId","undefined","pause","eof","_result","JSON","parse","warn","chunk","slice","fileReader","FileReader","onloadend","srcElement","target","onerror","readAsDataURL","FileReaderSync","onPause","postMessage","f","sc","cc","cs","ib","_len","ceil","clone","handleStart","continueFunc","_Start","pipe","func","push","isUploadAllowed","_getUser","autorun","computation","curValue","status","connected","onmessage","manual","self","setInterval","_currentTime","continue","toggle"],"mappings":"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","file":"packages/ostrio:files/upload.js.map","sourcesContent":["import { _ }            from 'meteor/underscore';\nimport { HTTP }         from 'meteor/http';\nimport { Meteor }       from 'meteor/meteor';\nimport { Random }       from 'meteor/random';\nimport { Tracker }      from 'meteor/tracker';\nimport { ReactiveVar }  from 'meteor/reactive-var';\nimport { EventEmitter } from 'eventemitter3';\nimport { check, Match } from 'meteor/check';\nimport { fixJSONParse, fixJSONStringify } from './lib.js';\n\nconst isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);\n\n/*\n * @locus Client\n * @name UploadInstance\n * @class UploadInstance\n * @summary Internal Class, used for file upload\n */\nexport class UploadInstance extends EventEmitter {\n  constructor(config, collection) {\n    super();\n    this.config     = config;\n    this.collection = collection;\n    this.collection._debug('[FilesCollection] [insert()]');\n\n    if (!this.config.ddp) {\n      this.config.ddp = this.collection.ddp;\n    }\n\n    if (!this.config.meta) {\n      this.config.meta = {};\n    }\n\n    if (!this.config.streams) {\n      this.config.streams = 2;\n    }\n\n    if (this.config.streams < 1) {\n      this.config.streams = 2;\n    }\n\n    if (!_.isString(this.config.transport)) {\n      this.config.transport = 'ddp';\n    }\n\n    this.config.transport = this.config.transport.toLowerCase();\n\n    if (this.config.transport !== 'ddp' && this.config.transport !== 'http') {\n      this.config.transport = 'ddp';\n    }\n\n    if (!this.config.chunkSize) {\n      this.config.chunkSize = this.collection.chunkSize;\n    }\n\n    if (!_.isBoolean(this.config.allowWebWorkers)) {\n      this.config.allowWebWorkers = true;\n    }\n\n    check(this.config, {\n      ddp: Match.Any,\n      file: Match.Any,\n      meta: Match.Optional(Object),\n      type: Match.Optional(String),\n      onError: Match.Optional(Function),\n      onAbort: Match.Optional(Function),\n      streams: Match.OneOf('dynamic', Number),\n      onStart: Match.Optional(Function),\n      fileName: Match.Optional(String),\n      isBase64: Match.Optional(Boolean),\n      transport: Match.OneOf('http', 'ddp'),\n      chunkSize: Match.OneOf('dynamic', Number),\n      onUploaded: Match.Optional(Function),\n      onProgress: Match.Optional(Function),\n      onBeforeUpload: Match.Optional(Function),\n      allowWebWorkers: Boolean\n    });\n\n    if (this.config.isBase64 === true) {\n      check(this.config.file, String);\n\n      if (!this.config.fileName) {\n        throw new Meteor.Error(400, '\"fileName\" must me specified for base64 upload!');\n      }\n\n      if (!!~this.config.file.indexOf('data:')) {\n        this.config.file = this.config.file.replace('data:', '');\n      }\n\n      if (!!~this.config.file.indexOf(',')) {\n        const _file = this.config.file.split(',');\n        this.fileData = {\n          size: Math.floor(((_file[1].replace(/\\=/g, '')).length / 4) * 3),\n          type: _file[0].split(';')[0],\n          name: this.config.fileName,\n          meta: this.config.meta\n        };\n        this.config.file = _file[1];\n      } else if (!this.config.type) {\n        throw new Meteor.Error(400, '\"type\" must me specified for base64 upload! And represent mime-type of the file');\n      } else {\n        this.fileData = {\n          size: Math.floor(((this.config.file.replace(/\\=/g, '')).length / 4) * 3),\n          type: this.config.type,\n          name: this.config.fileName,\n          meta: this.config.meta\n        };\n      }\n    }\n\n    if (this.config.file) {\n      if (!this.config.isBase64) {\n        try {\n          if (!this.config.file.name || !this.config.file.size) {\n            throw new Meteor.Error(500, 'Not a File!');\n          }\n        } catch (e) {\n          throw new Meteor.Error(500, '[FilesCollection] [insert] Insert method accepts File, not a FileList. You need to provide a real File. File must have `.name` property, and its size must be larger than zero.');\n        }\n\n        this.fileData = {\n          size: this.config.file.size,\n          type: this.config.type || this.config.file.type,\n          name: this.config.fileName || this.config.file.name,\n          meta: this.config.meta\n        };\n      }\n\n      if (this.collection.debug) {\n        console.time(`insert ${this.fileData.name}`);\n        console.time(`loadFile ${this.fileData.name}`);\n      }\n\n      if (this.collection._supportWebWorker && this.config.allowWebWorkers) {\n        try {\n          this.worker = new Worker(this.collection._webWorkerUrl);\n        } catch (wwError) {\n          this.worker = false;\n          this.collection._debug('[FilesCollection] [insert] [create WebWorker]: Can\\'t create WebWorker, fallback to MainThread', wwError);\n        }\n      } else {\n        this.worker = null;\n      }\n\n      this.startTime     = {};\n      this.config.debug  = this.collection.debug;\n      this.config._debug = this.collection._debug;\n      this.currentChunk  = 0;\n      this.transferTime  = 0;\n      this.trackerComp   = null;\n      this.sentChunks    = 0;\n      this.fileLength    = 1;\n      this.EOFsent       = false;\n      this.fileId        = Random.id();\n      this.FSName        = this.collection.namingFunction ? this.collection.namingFunction(this.fileData) : this.fileId;\n      this.pipes         = [];\n\n      this.fileData = _.extend(this.fileData, this.collection._getExt(this.fileData.name), {mime: this.collection._getMimeType(this.fileData)});\n      this.fileData['mime-type'] = this.fileData.mime;\n\n      this.result = new FileUpload(_.extend(this.config, {\n        fileData: this.fileData,\n        fileId: this.fileId,\n        _Abort: this.collection._methodNames._Abort\n      }));\n\n      this.beforeunload = (e) => {\n        const message = _.isFunction(this.collection.onbeforeunloadMessage) ? this.collection.onbeforeunloadMessage.call(this.result, this.fileData) : this.collection.onbeforeunloadMessage;\n\n        if (e) {\n          e.returnValue = message;\n        }\n        return message;\n      };\n\n      this.result.config.beforeunload = this.beforeunload;\n      window.addEventListener('beforeunload', this.beforeunload, false);\n\n      this.result.config._onEnd = () => this.emit('_onEnd');\n\n      this.addListener('end', this.end);\n      this.addListener('start', this.start);\n      this.addListener('upload', this.upload);\n      this.addListener('sendEOF', this.sendEOF);\n      this.addListener('prepare', this.prepare);\n      this.addListener('sendChunk', this.sendChunk);\n      this.addListener('proceedChunk', this.proceedChunk);\n      this.addListener('createStreams', this.createStreams);\n\n      this.addListener('calculateStats', _.throttle(() => {\n        const _t = (this.transferTime / this.sentChunks) / this.config.streams;\n        this.result.estimateTime.set((_t * (this.fileLength - this.sentChunks)));\n        this.result.estimateSpeed.set((this.config.chunkSize / (_t / 1000)));\n\n        const progress = Math.round((this.sentChunks / this.fileLength) * 100);\n        this.result.progress.set(progress);\n        this.config.onProgress && this.config.onProgress.call(this.result, progress, this.fileData);\n        this.result.emit('progress', progress, this.fileData);\n      }, 250));\n\n      this.addListener('_onEnd', () => {\n        if (this.result.estimateTimer) {\n          Meteor.clearInterval(this.result.estimateTimer);\n        }\n        if (this.worker) {\n          this.worker.terminate();\n        }\n        if (this.trackerComp) {\n          this.trackerComp.stop();\n        }\n        if (this.beforeunload) {\n          window.removeEventListener('beforeunload', this.beforeunload, false);\n        }\n        if (this.result) {\n          return this.result.progress.set(0);\n        }\n        return void 0;\n      });\n    } else {\n      throw new Meteor.Error(500, '[FilesCollection] [insert] Have you forget to pass a File itself?');\n    }\n  }\n\n  end(error, data) {\n    this.collection._debug('[FilesCollection] [UploadInstance] [end]', this.fileData.name);\n    if (this.collection.debug) {\n      console.timeEnd(`insert ${this.fileData.name}`);\n    }\n\n    this.emit('_onEnd');\n    this.result.emit('uploaded', error, data);\n    this.config.onUploaded && this.config.onUploaded.call(this.result, error, data);\n\n    if (error) {\n      this.collection._debug('[FilesCollection] [insert] [end] Error:', error);\n      this.result.abort();\n      this.result.state.set('aborted');\n      this.result.emit('error', error, this.fileData);\n      this.config.onError && this.config.onError.call(this.result, error, this.fileData);\n    } else {\n      this.result.state.set('completed');\n      this.collection.emit('afterUpload', data);\n    }\n    this.result.emit('end', error, (data || this.fileData));\n    return this.result;\n  }\n\n  sendChunk(evt) {\n    const opts = {\n      fileId: this.fileId,\n      binData: evt.data.bin,\n      chunkId: evt.data.chunkId\n    };\n\n    if (this.config.isBase64) {\n      const pad = opts.binData.length % 4;\n      if (pad) {\n        let p = 0;\n        while (p < pad) {\n          opts.binData += '=';\n          p++;\n        }\n      }\n    }\n\n    this.emit('data', evt.data.bin);\n    if (this.pipes.length) {\n      for (let i = this.pipes.length - 1; i >= 0; i--) {\n        opts.binData = this.pipes[i](opts.binData);\n      }\n    }\n\n    if (this.fileLength === evt.data.chunkId) {\n      if (this.collection.debug) {\n        console.timeEnd(`loadFile ${this.fileData.name}`);\n      }\n      this.emit('readEnd');\n    }\n\n    if (opts.binData) {\n      if (this.config.transport === 'ddp') {\n        this.config.ddp.call(this.collection._methodNames._Write, opts, (error) => {\n          this.transferTime += (+new Date) - this.startTime[opts.chunkId];\n          if (error) {\n            if (this.result.state.get() !== 'aborted') {\n              this.emit('end', error);\n            }\n          } else {\n            ++this.sentChunks;\n            if (this.sentChunks >= this.fileLength) {\n              this.emit('sendEOF');\n            } else if (this.currentChunk < this.fileLength) {\n              this.emit('upload');\n            }\n            this.emit('calculateStats');\n          }\n        });\n      } else {\n        HTTP.call('POST', `${this.collection.downloadRoute}/${this.collection.collectionName}/__upload`, {\n          content: opts.binData,\n          headers: {\n            'x-mtok': (_.isObject(Meteor.connection) ? Meteor.connection._lastSessionId : undefined) || null,\n            'x-fileid': opts.fileId,\n            'x-chunkid': opts.chunkId,\n            'content-type': 'text/plain'\n          }\n        }, (error) => {\n          this.transferTime += +new Date() - this.startTime[opts.chunkId];\n          if (error) {\n            if (`${error}` === 'Error: network') {\n              this.result.pause();\n            } else {\n              if (this.result.state.get() !== 'aborted') {\n                this.emit('end', error);\n              }\n            }\n          } else {\n            ++this.sentChunks;\n            if (this.sentChunks >= this.fileLength) {\n              this.emit('sendEOF');\n            } else if (this.currentChunk < this.fileLength) {\n              this.emit('upload');\n            }\n            this.emit('calculateStats');\n          }\n        });\n      }\n    }\n  }\n\n  sendEOF() {\n    this.collection._debug('[FilesCollection] [UploadInstance] [sendEOF]', this.EOFsent);\n    if (!this.EOFsent) {\n      this.EOFsent = true;\n      const opts = {\n        eof: true,\n        fileId: this.fileId\n      };\n\n      if (this.config.transport === 'ddp') {\n        this.config.ddp.call(this.collection._methodNames._Write, opts, (error, result) => {\n          this.emit('end', error, result);\n        });\n      } else {\n        HTTP.call('POST', `${this.collection.downloadRoute}/${this.collection.collectionName}/__upload`, {\n          content: '',\n          headers: {\n            'x-eof': '1',\n            'x-mtok': (_.isObject(Meteor.connection) ? Meteor.connection._lastSessionId : undefined) || null,\n            'x-fileId': opts.fileId,\n            'content-type': 'text/plain'\n          }\n        }, (error, _result) => {\n          let result;\n          try {\n            result = JSON.parse((_.isObject(_result) ? _result.content : undefined) || {});\n          } catch (e) {\n            console.warn('Something went wrong! [sendEOF] method doesn\\'t returned JSON! Looks like you\\'re on Cordova app or behind proxy, switching to DDP transport is recommended.');\n            result = {};\n          }\n\n          if (result.meta) {\n            result.meta = fixJSONParse(result.meta);\n          }\n\n          this.emit('end', error, result);\n        });\n      }\n    }\n  }\n\n  proceedChunk(chunkId) {\n    const chunk = this.config.file.slice((this.config.chunkSize * (chunkId - 1)), (this.config.chunkSize * chunkId));\n\n    if (this.config.isBase64) {\n      this.emit('sendChunk', {\n        data: {\n          bin: chunk,\n          chunkId\n        }\n      });\n    } else {\n      let fileReader;\n      if (FileReader) {\n        fileReader = new FileReader;\n\n        fileReader.onloadend = (evt) => {\n          this.emit('sendChunk', {\n            data: {\n              bin: ((_.isObject(fileReader) ? fileReader.result : undefined) || (evt.srcElement ? evt.srcElement.result : undefined) || (evt.target ? evt.target.result : undefined)).split(',')[1],\n              chunkId\n            }\n          });\n        };\n\n        fileReader.onerror = (e) => {\n          this.emit('end', (e.target || e.srcElement).error);\n        };\n\n        fileReader.readAsDataURL(chunk);\n      } else if (FileReaderSync) {\n        fileReader = new FileReaderSync;\n\n        this.emit('sendChunk', {\n          data: {\n            bin: fileReader.readAsDataURL(chunk).split(',')[1],\n            chunkId\n          }\n        });\n      } else {\n        this.emit('end', 'File API is not supported in this Browser!');\n      }\n    }\n  }\n\n  upload() {\n    if (this.result.onPause.get()) {\n      return this;\n    }\n\n    if (this.result.state.get() === 'aborted') {\n      return this;\n    }\n\n    if (this.currentChunk <= this.fileLength) {\n      ++this.currentChunk;\n      if (this.worker) {\n        this.worker.postMessage({\n          f: this.config.file,\n          sc: this.sentChunks,\n          cc: this.currentChunk,\n          cs: this.config.chunkSize,\n          ib: this.config.isBase64\n        });\n      } else {\n        this.emit('proceedChunk', this.currentChunk);\n      }\n    } else {\n      this.emit('sendEOF');\n    }\n    this.startTime[this.currentChunk] = +new Date();\n    return this;\n  }\n\n  createStreams() {\n    this.collection._debug('[FilesCollection] [UploadInstance] [createStreams]');\n    let i = 1;\n    while (i <= this.config.streams) {\n      this.emit('upload');\n      i++;\n    }\n  }\n\n  prepare() {\n    let _len;\n\n    this.config.onStart && this.config.onStart.call(this.result, null, this.fileData);\n    this.result.emit('start', null, this.fileData);\n\n    if (this.config.chunkSize === 'dynamic') {\n      this.config.chunkSize = this.fileData.size / 1000;\n      if (this.config.chunkSize < 327680) {\n        this.config.chunkSize = 327680;\n      } else if (this.config.chunkSize > 1048576) {\n        this.config.chunkSize = 1048576;\n      }\n\n      if (this.config.transport === 'http') {\n        this.config.chunkSize = Math.round(this.config.chunkSize / 2);\n      } else if (isSafari) {\n        this.config.chunkSize = Math.ceil(this.config.chunkSize / 8);\n      }\n    }\n\n    if (this.config.isBase64) {\n      this.config.chunkSize = Math.floor(this.config.chunkSize / 4) * 4;\n      _len = Math.ceil(this.config.file.length / this.config.chunkSize);\n    } else {\n      this.config.chunkSize = Math.floor(this.config.chunkSize / 8) * 8;\n      _len = Math.ceil(this.fileData.size / this.config.chunkSize);\n    }\n\n    if (this.config.streams === 'dynamic') {\n      this.config.streams = _.clone(_len);\n      if (this.config.streams > 24) { this.config.streams = 24; }\n\n      if (this.config.transport === 'http') {\n        this.config.streams = Math.round(this.config.streams / 2);\n      } else if (isSafari) {\n        this.config.streams = 1;\n      }\n    }\n\n    this.fileLength = _len <= 0 ? 1 : _len;\n    if (this.config.streams > this.fileLength) {\n      this.config.streams = this.fileLength;\n    }\n    this.result.config.fileLength = this.fileLength;\n\n    const opts = {\n      file: this.fileData,\n      fileId: this.fileId,\n      chunkSize: this.config.isBase64 ? ((this.config.chunkSize  / 4) * 3) : this.config.chunkSize,\n      fileLength: this.fileLength\n    };\n\n    if (this.FSName !== this.fileId) {\n      opts.FSName = this.FSName;\n    }\n\n    const handleStart = (error) => {\n      if (error) {\n        this.collection._debug('[FilesCollection] [_Start] Error:', error);\n        this.emit('end', error);\n      } else {\n        this.result.continueFunc = () => {\n          this.collection._debug('[FilesCollection] [insert] [continueFunc]');\n          this.emit('createStreams');\n        };\n        this.emit('createStreams');\n      }\n    };\n\n    if (this.config.transport === 'ddp') {\n      this.config.ddp.call(this.collection._methodNames._Start, opts, handleStart);\n    } else {\n      if (_.isObject(opts.file) ? opts.file.meta : undefined) {\n        opts.file.meta = fixJSONStringify(opts.file.meta);\n      }\n\n      HTTP.call('POST', `${this.collection.downloadRoute}/${this.collection.collectionName}/__upload`, {\n        data: opts,\n        headers: {\n          'x-start': '1',\n          'x-mtok': (_.isObject(Meteor.connection) ? Meteor.connection._lastSessionId : undefined) || null\n        }\n      }, handleStart);\n    }\n  }\n\n  pipe(func) {\n    this.pipes.push(func);\n    return this;\n  }\n\n  start() {\n    let isUploadAllowed;\n    if (this.fileData.size <= 0) {\n      this.end(new Meteor.Error(400, 'Can\\'t upload empty file'));\n      return this.result;\n    }\n\n    if (this.config.onBeforeUpload && _.isFunction(this.config.onBeforeUpload)) {\n      isUploadAllowed = this.config.onBeforeUpload.call(_.extend(this.result, this.collection._getUser()), this.fileData);\n      if (isUploadAllowed !== true) {\n        return this.end(new Meteor.Error(403, _.isString(isUploadAllowed) ? isUploadAllowed : 'config.onBeforeUpload() returned false'));\n      }\n    }\n\n    if (this.collection.onBeforeUpload && _.isFunction(this.collection.onBeforeUpload)) {\n      isUploadAllowed = this.collection.onBeforeUpload.call(_.extend(this.result, this.collection._getUser()), this.fileData);\n      if (isUploadAllowed !== true) {\n        return this.end(new Meteor.Error(403, _.isString(isUploadAllowed) ? isUploadAllowed : 'collection.onBeforeUpload() returned false'));\n      }\n    }\n\n    Tracker.autorun((computation) => {\n      this.trackerComp = computation;\n      if (!this.result.onPause.curValue && !Meteor.status().connected) {\n        this.collection._debug('[FilesCollection] [insert] [Tracker] [pause]');\n        this.result.pause();\n      }\n    });\n\n    if (this.worker) {\n      this.collection._debug('[FilesCollection] [insert] using WebWorkers');\n      this.worker.onmessage = (evt) => {\n        if (evt.data.error) {\n          this.collection._debug('[FilesCollection] [insert] [worker] [onmessage] [ERROR:]', evt.data.error);\n          this.emit('proceedChunk', evt.data.chunkId);\n        } else {\n          this.emit('sendChunk', evt);\n        }\n      };\n\n      this.worker.onerror = (e) => {\n        this.collection._debug('[FilesCollection] [insert] [worker] [onerror] [ERROR:]', e);\n        this.emit('end', e.message);\n      };\n    } else {\n      this.collection._debug('[FilesCollection] [insert] using MainThread');\n    }\n\n    this.emit('prepare');\n    return this.result;\n  }\n\n  manual() {\n    this.result.start = () => {\n      this.emit('start');\n    };\n\n    this.result.pipe = function (func) {\n      self.pipe(func);\n      return this;\n    };\n    return this.result;\n  }\n}\n\n/*\n * @locus Client\n * @name FileUpload\n * @class FileUpload\n * @summary Internal Class, instance of this class is returned from `.insert()` method\n */\nexport class FileUpload extends EventEmitter {\n  constructor(config) {\n    super();\n    this.config = config;\n    this.config._debug('[FilesCollection] [FileUpload] [constructor]');\n\n    if (!this.config.isBase64) {\n      this.file        = _.extend(this.config.file, this.config.fileData);\n    } else {\n      this.file        = this.config.fileData;\n    }\n    this.state         = new ReactiveVar('active');\n    this.onPause       = new ReactiveVar(false);\n    this.progress      = new ReactiveVar(0);\n    this.continueFunc  = () => { };\n    this.estimateTime  = new ReactiveVar(1000);\n    this.estimateSpeed = new ReactiveVar(0);\n    this.estimateTimer = Meteor.setInterval(() => {\n      if (this.state.get() === 'active') {\n        const _currentTime = this.estimateTime.get();\n        if (_currentTime > 1000) {\n          this.estimateTime.set(_currentTime - 1000);\n        }\n      }\n    }, 1000);\n  }\n  pause() {\n    this.config._debug('[FilesCollection] [insert] [.pause()]');\n    if (!this.onPause.get()) {\n      this.onPause.set(true);\n      this.state.set('paused');\n      this.emit('pause', this.file);\n    }\n  }\n  continue() {\n    this.config._debug('[FilesCollection] [insert] [.continue()]');\n    if (this.onPause.get()) {\n      this.onPause.set(false);\n      this.state.set('active');\n      this.emit('continue', this.file);\n      this.continueFunc();\n    }\n  }\n  toggle() {\n    this.config._debug('[FilesCollection] [insert] [.toggle()]');\n    if (this.onPause.get()) {\n      this.continue();\n    } else {\n      this.pause();\n    }\n  }\n  abort() {\n    this.config._debug('[FilesCollection] [insert] [.abort()]');\n    window.removeEventListener('beforeunload', this.config.beforeunload, false);\n    this.config.onAbort && this.config.onAbort.call(this, this.file);\n    this.emit('abort', this.file);\n    this.pause();\n    this.config._onEnd();\n    this.state.set('aborted');\n    if (this.config.debug) {\n      console.timeEnd(`insert ${this.config.fileData.name}`);\n    }\n\n    this.config.ddp.call(this.config._Abort, this.config.fileId);\n  }\n}\n"]},"hash":"9af507b93ac4577269a52fd6741ef00495213ca8"}
